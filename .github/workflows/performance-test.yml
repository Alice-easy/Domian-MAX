# æ€§èƒ½æµ‹è¯•å·¥ä½œæµï¼ˆé»˜è®¤ç¦ç”¨ï¼‰
name: Performance Test

on:
  # é»˜è®¤ç¦ç”¨è‡ªåŠ¨è§¦å‘ï¼Œéœ€è¦æ‰‹åŠ¨å¯ç”¨
  # schedule:
  #   # æ¯å‘¨æ—¥å‡Œæ™¨ 3:00 UTC è¿è¡Œæ€§èƒ½æµ‹è¯•
  #   - cron: "0 3 * * 0"
  # push:
  #   branches: [main]
  #   paths-ignore:
  #     - "docs/**"
  #     - "*.md"
  workflow_dispatch:
    inputs:
      enable_workflow:
        description: "å¯ç”¨å·¥ä½œæµï¼ˆé»˜è®¤ç¦ç”¨ï¼‰"
        required: true
        default: false
        type: boolean
      test_duration:
        description: "æµ‹è¯•æŒç»­æ—¶é—´"
        required: false
        default: "5m"
        type: string
      virtual_users:
        description: "è™šæ‹Ÿç”¨æˆ·æ•°"
        required: false
        default: "50"
        type: string
      test_scenarios:
        description: "æµ‹è¯•åœºæ™¯"
        required: false
        default: "all"
        type: choice
        options:
          - all
          - auth
          - dns
          - admin

env:
  TEST_DURATION: ${{ inputs.test_duration || '5m' }}
  VIRTUAL_USERS: ${{ inputs.virtual_users || '50' }}
  TEST_SCENARIOS: ${{ inputs.test_scenarios || 'all' }}

jobs:
  # ===== æ€§èƒ½æµ‹è¯•ç¯å¢ƒå‡†å¤‡ =====
  setup-test-environment:
    name: å‡†å¤‡æ€§èƒ½æµ‹è¯•ç¯å¢ƒ
    runs-on: ubuntu-latest
    outputs:
      test-url: ${{ steps.setup.outputs.test-url }}

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½®æµ‹è¯•ç¯å¢ƒ
        id: setup
        run: |
          # åˆ›å»ºæ€§èƒ½æµ‹è¯•é…ç½®
          cp deployments/.env.example deployments/.env
          cat >> deployments/.env << EOF
          DB_PASSWORD=perftest123
          JWT_SECRET=performance-test-jwt-secret-key-for-testing
          ENCRYPTION_KEY=12345678901234567890123456789012
          LOG_LEVEL=error
          ENVIRONMENT=performance-test
          EOF

      - name: å¯åŠ¨æµ‹è¯•ç¯å¢ƒ
        run: |
          cd deployments
          docker-compose up -d --build

          # ç­‰å¾…æœåŠ¡å¯åŠ¨
          timeout 300 bash -c 'until curl -f http://localhost:8080/api/health; do sleep 5; done'

          echo "test-url=http://localhost:8080" >> $GITHUB_OUTPUT

      - name: éªŒè¯æµ‹è¯•ç¯å¢ƒ
        run: |
          # éªŒè¯æ‰€æœ‰æœåŠ¡éƒ½æ­£å¸¸è¿è¡Œ
          curl -f http://localhost:8080/api/health
          docker-compose ps

  # ===== è´Ÿè½½æµ‹è¯• =====
  load-test:
    name: è´Ÿè½½æµ‹è¯•
    runs-on: ubuntu-latest
    needs: setup-test-environment

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: å®‰è£… K6
        run: |
          sudo gpg -k
          sudo gpg --no-default-keyring --keyring /usr/share/keyrings/k6-archive-keyring.gpg --keyserver hkp://keyserver.ubuntu.com:80 --recv-keys C5AD17C747E3415A3642D57D77C6C491D6AC1D69
          echo "deb [signed-by=/usr/share/keyrings/k6-archive-keyring.gpg] https://dl.k6.io/deb stable main" | sudo tee /etc/apt/sources.list.d/k6.list
          sudo apt-get update
          sudo apt-get install k6

      - name: åˆ›å»ºæ€§èƒ½æµ‹è¯•è„šæœ¬
        run: |
          mkdir -p performance-tests

          # åˆ›å»ºä¸»æµ‹è¯•è„šæœ¬
          cat > performance-tests/load-test.js << 'EOF'
          import http from 'k6/http';
          import { check, sleep } from 'k6';
          import { Rate } from 'k6/metrics';

          // è‡ªå®šä¹‰æŒ‡æ ‡
          export let errorRate = new Rate('errors');

          // æµ‹è¯•é…ç½®
          export let options = {
            stages: [
              { duration: '2m', target: parseInt(__ENV.VIRTUAL_USERS) / 2 }, // é¢„çƒ­
              { duration: __ENV.TEST_DURATION || '5m', target: parseInt(__ENV.VIRTUAL_USERS) }, // è´Ÿè½½æµ‹è¯•
              { duration: '2m', target: 0 }, // å†·å´
            ],
            thresholds: {
              http_req_duration: ['p(95)<2000'], // 95% çš„è¯·æ±‚åœ¨ 2 ç§’å†…å®Œæˆ
              http_req_failed: ['rate<0.1'], // é”™è¯¯ç‡å°äº 10%
              errors: ['rate<0.1'],
            },
          };

          const BASE_URL = __ENV.BASE_URL || 'http://localhost:8080';

          // æµ‹è¯•ç”¨æˆ·è®¤è¯
          export function setup() {
            // æ³¨å†Œæµ‹è¯•ç”¨æˆ·
            const registerPayload = JSON.stringify({
              email: `perftest${Date.now()}@example.com`,
              password: 'PerfTest123!',
              name: 'Performance Test User'
            });

            const registerRes = http.post(`${BASE_URL}/api/auth/register`, registerPayload, {
              headers: { 'Content-Type': 'application/json' },
            });

            if (registerRes.status === 201) {
              // ç™»å½•è·å– token
              const loginPayload = JSON.stringify({
                email: `perftest${Date.now()}@example.com`,
                password: 'PerfTest123!'
              });

              const loginRes = http.post(`${BASE_URL}/api/auth/login`, loginPayload, {
                headers: { 'Content-Type': 'application/json' },
              });

              if (loginRes.status === 200) {
                const token = JSON.parse(loginRes.body).token;
                return { token: token };
              }
            }

            return { token: null };
          }

          export default function(data) {
            const scenarios = __ENV.TEST_SCENARIOS || 'all';
            
            // å¥åº·æ£€æŸ¥æµ‹è¯•
            if (scenarios === 'all' || scenarios === 'health') {
              let res = http.get(`${BASE_URL}/api/health`);
              check(res, {
                'health check status is 200': (r) => r.status === 200,
                'health check response time < 500ms': (r) => r.timings.duration < 500,
              }) || errorRate.add(1);
            }

            // è®¤è¯ç›¸å…³æµ‹è¯•
            if (scenarios === 'all' || scenarios === 'auth') {
              const headers = data.token ? {
                'Authorization': `Bearer ${data.token}`,
                'Content-Type': 'application/json'
              } : { 'Content-Type': 'application/json' };

              // è·å–ç”¨æˆ·ä¿¡æ¯
              if (data.token) {
                let profileRes = http.get(`${BASE_URL}/api/auth/profile`, { headers });
                check(profileRes, {
                  'profile status is 200': (r) => r.status === 200,
                  'profile response time < 1000ms': (r) => r.timings.duration < 1000,
                }) || errorRate.add(1);
              }
            }

            // DNS ç›¸å…³æµ‹è¯•
            if (scenarios === 'all' || scenarios === 'dns') {
              const headers = data.token ? {
                'Authorization': `Bearer ${data.token}`,
                'Content-Type': 'application/json'
              } : {};

              // è·å– DNS è®°å½•
              let dnsRes = http.get(`${BASE_URL}/api/dns/records`, { headers });
              check(dnsRes, {
                'dns records response time < 1500ms': (r) => r.timings.duration < 1500,
              }) || errorRate.add(1);

              // è·å–åŸŸååˆ—è¡¨
              let domainsRes = http.get(`${BASE_URL}/api/domains`, { headers });
              check(domainsRes, {
                'domains response time < 1000ms': (r) => r.timings.duration < 1000,
              }) || errorRate.add(1);
            }

            // ç®¡ç†åŠŸèƒ½æµ‹è¯•
            if (scenarios === 'all' || scenarios === 'admin') {
              const headers = data.token ? {
                'Authorization': `Bearer ${data.token}`,
                'Content-Type': 'application/json'
              } : {};

              // è·å–ç”¨æˆ·åˆ—è¡¨ï¼ˆç®¡ç†åŠŸèƒ½ï¼‰
              let adminRes = http.get(`${BASE_URL}/api/admin/users`, { headers });
              check(adminRes, {
                'admin response time < 2000ms': (r) => r.timings.duration < 2000,
              }) || errorRate.add(1);
            }

            sleep(1); // ç”¨æˆ·æ€è€ƒæ—¶é—´
          }

          export function teardown(data) {
            // æ¸…ç†æµ‹è¯•æ•°æ®
            console.log('æ€§èƒ½æµ‹è¯•å®Œæˆ');
          }
          EOF

      - name: è¿è¡Œè´Ÿè½½æµ‹è¯•
        env:
          BASE_URL: ${{ needs.setup-test-environment.outputs.test-url }}
        run: |
          k6 run \
            --out json=load-test-results.json \
            --env BASE_URL=$BASE_URL \
            --env TEST_DURATION=$TEST_DURATION \
            --env VIRTUAL_USERS=$VIRTUAL_USERS \
            --env TEST_SCENARIOS=$TEST_SCENARIOS \
            performance-tests/load-test.js

      - name: ä¸Šä¼ è´Ÿè½½æµ‹è¯•ç»“æœ
        uses: actions/upload-artifact@v3
        with:
          name: load-test-results
          path: load-test-results.json

  # ===== å‹åŠ›æµ‹è¯• =====
  stress-test:
    name: å‹åŠ›æµ‹è¯•
    runs-on: ubuntu-latest
    needs: setup-test-environment

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: å®‰è£… K6
        run: |
          sudo gpg -k
          sudo gpg --no-default-keyring --keyring /usr/share/keyrings/k6-archive-keyring.gpg --keyserver hkp://keyserver.ubuntu.com:80 --recv-keys C5AD17C747E3415A3642D57D77C6C491D6AC1D69
          echo "deb [signed-by=/usr/share/keyrings/k6-archive-keyring.gpg] https://dl.k6.io/deb stable main" | sudo tee /etc/apt/sources.list.d/k6.list
          sudo apt-get update
          sudo apt-get install k6

      - name: åˆ›å»ºå‹åŠ›æµ‹è¯•è„šæœ¬
        run: |
          mkdir -p performance-tests

          cat > performance-tests/stress-test.js << 'EOF'
          import http from 'k6/http';
          import { check, sleep } from 'k6';

          export let options = {
            stages: [
              { duration: '1m', target: 50 },   // é¢„çƒ­åˆ° 50 ç”¨æˆ·
              { duration: '2m', target: 100 },  // å¢åŠ åˆ° 100 ç”¨æˆ·
              { duration: '3m', target: 200 },  // å‹åŠ›æµ‹è¯• 200 ç”¨æˆ·
              { duration: '2m', target: 400 },  // æé™å‹åŠ› 400 ç”¨æˆ·
              { duration: '1m', target: 0 },    // å†·å´
            ],
            thresholds: {
              http_req_duration: ['p(95)<5000'], // 95% çš„è¯·æ±‚åœ¨ 5 ç§’å†…å®Œæˆ
              http_req_failed: ['rate<0.3'], // é”™è¯¯ç‡å°äº 30%
            },
          };

          const BASE_URL = __ENV.BASE_URL || 'http://localhost:8080';

          export default function() {
            let res = http.get(`${BASE_URL}/api/health`);
            check(res, {
              'status is 200': (r) => r.status === 200,
            });
            sleep(0.5);
          }
          EOF

      - name: è¿è¡Œå‹åŠ›æµ‹è¯•
        env:
          BASE_URL: ${{ needs.setup-test-environment.outputs.test-url }}
        run: |
          k6 run \
            --out json=stress-test-results.json \
            --env BASE_URL=$BASE_URL \
            performance-tests/stress-test.js

      - name: ä¸Šä¼ å‹åŠ›æµ‹è¯•ç»“æœ
        uses: actions/upload-artifact@v3
        with:
          name: stress-test-results
          path: stress-test-results.json

  # ===== å³°å€¼æµ‹è¯• =====
  spike-test:
    name: å³°å€¼æµ‹è¯•
    runs-on: ubuntu-latest
    needs: setup-test-environment

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: å®‰è£… K6
        run: |
          sudo gpg -k
          sudo gpg --no-default-keyring --keyring /usr/share/keyrings/k6-archive-keyring.gpg --keyserver hkp://keyserver.ubuntu.com:80 --recv-keys C5AD17C747E3415A3642D57D77C6C491D6AC1D69
          echo "deb [signed-by=/usr/share/keyrings/k6-archive-keyring.gpg] https://dl.k6.io/deb stable main" | sudo tee /etc/apt/sources.list.d/k6.list
          sudo apt-get update
          sudo apt-get install k6

      - name: åˆ›å»ºå³°å€¼æµ‹è¯•è„šæœ¬
        run: |
          mkdir -p performance-tests

          cat > performance-tests/spike-test.js << 'EOF'
          import http from 'k6/http';
          import { check, sleep } from 'k6';

          export let options = {
            stages: [
              { duration: '30s', target: 10 },   // æ­£å¸¸è´Ÿè½½
              { duration: '10s', target: 500 },  // çªç„¶å³°å€¼
              { duration: '30s', target: 500 },  // ç»´æŒå³°å€¼
              { duration: '10s', target: 10 },   // å¿«é€Ÿä¸‹é™
              { duration: '30s', target: 10 },   // æ¢å¤æ­£å¸¸
            ],
            thresholds: {
              http_req_duration: ['p(95)<10000'], // 95% çš„è¯·æ±‚åœ¨ 10 ç§’å†…å®Œæˆ
              http_req_failed: ['rate<0.5'], // é”™è¯¯ç‡å°äº 50%
            },
          };

          const BASE_URL = __ENV.BASE_URL || 'http://localhost:8080';

          export default function() {
            let res = http.get(`${BASE_URL}/api/health`);
            check(res, {
              'status is 200': (r) => r.status === 200,
            });
            sleep(0.1);
          }
          EOF

      - name: è¿è¡Œå³°å€¼æµ‹è¯•
        env:
          BASE_URL: ${{ needs.setup-test-environment.outputs.test-url }}
        run: |
          k6 run \
            --out json=spike-test-results.json \
            --env BASE_URL=$BASE_URL \
            performance-tests/spike-test.js

      - name: ä¸Šä¼ å³°å€¼æµ‹è¯•ç»“æœ
        uses: actions/upload-artifact@v3
        with:
          name: spike-test-results
          path: spike-test-results.json

  # ===== ç”Ÿæˆæ€§èƒ½æŠ¥å‘Š =====
  generate-performance-report:
    name: ç”Ÿæˆæ€§èƒ½æŠ¥å‘Š
    runs-on: ubuntu-latest
    needs: [load-test, stress-test, spike-test]
    if: always()

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: ä¸‹è½½æµ‹è¯•ç»“æœ
        uses: actions/download-artifact@v3

      - name: å®‰è£…åˆ†æå·¥å…·
        run: |
          npm install -g json2csv

      - name: åˆ†ææ€§èƒ½æµ‹è¯•ç»“æœ
        run: |
          echo "# ğŸš€ Domain MAX æ€§èƒ½æµ‹è¯•æŠ¥å‘Š" > performance-report.md
          echo "" >> performance-report.md
          echo "**æµ‹è¯•æ—¶é—´**: $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> performance-report.md
          echo "**æµ‹è¯•é…ç½®**: $VIRTUAL_USERS è™šæ‹Ÿç”¨æˆ·ï¼ŒæŒç»­ $TEST_DURATION" >> performance-report.md
          echo "**æµ‹è¯•åœºæ™¯**: $TEST_SCENARIOS" >> performance-report.md
          echo "" >> performance-report.md

          echo "## ğŸ“Š æµ‹è¯•ç»“æœæ€»è§ˆ" >> performance-report.md
          echo "" >> performance-report.md
          echo "| æµ‹è¯•ç±»å‹ | çŠ¶æ€ | è¯´æ˜ |" >> performance-report.md
          echo "|---------|------|------|" >> performance-report.md
          echo "| è´Ÿè½½æµ‹è¯• | ${{ needs.load-test.result == 'success' && 'âœ… é€šè¿‡' || 'âŒ å¤±è´¥' }} | æ­£å¸¸è´Ÿè½½ä¸‹çš„æ€§èƒ½è¡¨ç° |" >> performance-report.md
          echo "| å‹åŠ›æµ‹è¯• | ${{ needs.stress-test.result == 'success' && 'âœ… é€šè¿‡' || 'âŒ å¤±è´¥' }} | é«˜è´Ÿè½½ä¸‹çš„ç³»ç»Ÿç¨³å®šæ€§ |" >> performance-report.md
          echo "| å³°å€¼æµ‹è¯• | ${{ needs.spike-test.result == 'success' && 'âœ… é€šè¿‡' || 'âŒ å¤±è´¥' }} | çªå‘æµé‡çš„å¤„ç†èƒ½åŠ› |" >> performance-report.md
          echo "" >> performance-report.md

          # åˆ†æè´Ÿè½½æµ‹è¯•ç»“æœ
          if [ -f load-test-results/load-test-results.json ]; then
            echo "## ğŸ“ˆ è´Ÿè½½æµ‹è¯•è¯¦ç»†ç»“æœ" >> performance-report.md
            echo "" >> performance-report.md
            
            # æå–å…³é”®æŒ‡æ ‡
            cat load-test-results/load-test-results.json | jq -r '
              select(.type == "Point" and .metric == "http_req_duration") |
              .data.value
            ' | awk '{sum+=$1; count++} END {print "å¹³å‡å“åº”æ—¶é—´: " sum/count " ms"}' >> performance-report.md
            
            cat load-test-results/load-test-results.json | jq -r '
              select(.type == "Point" and .metric == "http_reqs") |
              .data.value
            ' | awk '{sum+=$1} END {print "æ€»è¯·æ±‚æ•°: " sum}' >> performance-report.md
            
            echo "" >> performance-report.md
          fi

          echo "## ğŸ¯ æ€§èƒ½ä¼˜åŒ–å»ºè®®" >> performance-report.md
          echo "" >> performance-report.md
          echo "åŸºäºæµ‹è¯•ç»“æœï¼Œå»ºè®®å…³æ³¨ä»¥ä¸‹ä¼˜åŒ–ç‚¹ï¼š" >> performance-report.md
          echo "" >> performance-report.md
          echo "1. **æ•°æ®åº“ä¼˜åŒ–**: æ£€æŸ¥æ…¢æŸ¥è¯¢ï¼Œä¼˜åŒ–ç´¢å¼•" >> performance-report.md
          echo "2. **ç¼“å­˜ç­–ç•¥**: å¢åŠ  Redis ç¼“å­˜ä½¿ç”¨" >> performance-report.md
          echo "3. **è¿æ¥æ± **: è°ƒä¼˜æ•°æ®åº“è¿æ¥æ± é…ç½®" >> performance-report.md
          echo "4. **è´Ÿè½½å‡è¡¡**: è€ƒè™‘æ¨ªå‘æ‰©å±•" >> performance-report.md
          echo "5. **èµ„æºç›‘æ§**: åŠ å¼º CPU å’Œå†…å­˜ç›‘æ§" >> performance-report.md

      - name: ä¸Šä¼ æ€§èƒ½æŠ¥å‘Š
        uses: actions/upload-artifact@v3
        with:
          name: performance-report
          path: performance-report.md

      - name: å‘é€æ€§èƒ½æŠ¥å‘Šé€šçŸ¥
        if: github.event_name == 'schedule' && secrets.SLACK_WEBHOOK_URL
        uses: 8398a7/action-slack@v3
        with:
          status: custom
          custom_payload: |
            {
              "text": "ğŸš€ Domain MAX æ€§èƒ½æµ‹è¯•å®Œæˆ",
              "attachments": [
                {
                  "color": "${{ contains(needs.*.result, 'failure') && 'warning' || 'good' }}",
                  "fields": [
                    {
                      "title": "æµ‹è¯•ç»“æœ",
                      "value": "è´Ÿè½½æµ‹è¯•: ${{ needs.load-test.result }}\nå‹åŠ›æµ‹è¯•: ${{ needs.stress-test.result }}\nå³°å€¼æµ‹è¯•: ${{ needs.spike-test.result }}",
                      "short": true
                    },
                    {
                      "title": "æµ‹è¯•é…ç½®",
                      "value": "ç”¨æˆ·æ•°: ${{ env.VIRTUAL_USERS }}\næŒç»­æ—¶é—´: ${{ env.TEST_DURATION }}",
                      "short": true
                    }
                  ]
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

  # ===== æ¸…ç†æµ‹è¯•ç¯å¢ƒ =====
  cleanup:
    name: æ¸…ç†æµ‹è¯•ç¯å¢ƒ
    runs-on: ubuntu-latest
    needs: [load-test, stress-test, spike-test]
    if: always()

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: æ¸…ç†æµ‹è¯•ç¯å¢ƒ
        run: |
          cd deployments
          docker-compose down -v
          docker system prune -f
