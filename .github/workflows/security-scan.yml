# å®‰å…¨æ‰«æå·¥ä½œæµï¼ˆé»˜è®¤ç¦ç”¨ï¼‰
name: Security Scan

on:
  # é»˜è®¤ç¦ç”¨è‡ªåŠ¨è§¦å‘ï¼Œéœ€è¦æ‰‹åŠ¨å¯ç”¨
  # schedule:
  #   # æ¯å¤©å‡Œæ™¨ 2:00 UTC è¿è¡Œå®‰å…¨æ‰«æ
  #   - cron: "0 2 * * *"
  # push:
  #   branches: [main, develop]
  # pull_request:
  #   branches: [main]
  workflow_dispatch:
    inputs:
      enable_workflow:
        description: "å¯ç”¨å·¥ä½œæµï¼ˆé»˜è®¤ç¦ç”¨ï¼‰"
        required: true
        default: false
        type: boolean
      scan_type:
        description: "æ‰«æç±»å‹"
        required: false
        default: "full"
        type: choice
        options:
          - code
          - dependencies
          - container
          - full

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  # ===== ä»£ç å®‰å…¨æ‰«æ =====
  code-security-scan:
    name: ä»£ç å®‰å…¨æ‰«æ
    runs-on: ubuntu-latest
    if: ${{ inputs.enable_workflow == true && (inputs.scan_type == 'code' || inputs.scan_type == 'full') }}

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # Go å®‰å…¨æ‰«æ
      - name: è®¾ç½® Go ç¯å¢ƒ
        uses: actions/setup-go@v4
        with:
          go-version: "1.23"

      - name: Go å®‰å…¨æ‰«æ (gosec)
        uses: securecodewarrior/github-action-gosec@master
        with:
          args: "-fmt sarif -out gosec-results.sarif ./..."

      - name: ä¸Šä¼  gosec ç»“æœ
        uses: github/codeql-action/upload-sarif@v2
        if: always()
        with:
          sarif_file: gosec-results.sarif

      # Go æ¼æ´æ‰«æ
      - name: Go æ¼æ´æ‰«æ (govulncheck)
        run: |
          go install golang.org/x/vuln/cmd/govulncheck@latest
          govulncheck ./...

      # Node.js å®‰å…¨æ‰«æ
      - name: è®¾ç½® Node.js ç¯å¢ƒ
        uses: actions/setup-node@v4
        with:
          node-version: "18"
          cache: "npm"
          cache-dependency-path: web/package-lock.json

      - name: Node.js å®‰å…¨å®¡è®¡
        working-directory: ./web
        run: |
          npm ci
          npm audit --audit-level=high

      # ä»£ç è´¨é‡å’Œå®‰å…¨æ‰«æ
      - name: SonarCloud æ‰«æ
        if: env.SONAR_TOKEN != ''
        uses: SonarSource/sonarcloud-github-action@master
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}

      # æ•æ„Ÿä¿¡æ¯æ‰«æ
      - name: æ•æ„Ÿä¿¡æ¯æ‰«æ (truffleHog)
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: main
          head: HEAD
          extra_args: --debug --only-verified

  # ===== ä¾èµ–å®‰å…¨æ‰«æ =====
  dependency-security-scan:
    name: ä¾èµ–å®‰å…¨æ‰«æ
    runs-on: ubuntu-latest

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      # Go æ¨¡å—å®‰å…¨æ‰«æ
      - name: è®¾ç½® Go ç¯å¢ƒ
        uses: actions/setup-go@v4
        with:
          go-version: "1.23"

      - name: Nancy æ‰«æ Go ä¾èµ–
        run: |
          go list -json -deps ./... | curl -sSL --data-binary @- https://nancy.sonatype.com/api/v1/vulnerable-dependencies

      # Node.js ä¾èµ–æ‰«æ
      - name: è®¾ç½® Node.js ç¯å¢ƒ
        uses: actions/setup-node@v4
        with:
          node-version: "18"

      - name: Snyk ä¾èµ–æ‰«æ
        if: env.SNYK_TOKEN != ''
        uses: snyk/actions/node@master
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          args: --file=web/package.json --severity-threshold=high

      # è®¸å¯è¯åˆè§„æ£€æŸ¥
      - name: FOSSA è®¸å¯è¯æ‰«æ
        if: env.FOSSA_API_KEY != ''
        uses: fossas/fossa-action@main
        with:
          api-key: ${{ secrets.FOSSA_API_KEY }}

  # ===== å®¹å™¨å®‰å…¨æ‰«æ =====
  container-security-scan:
    name: å®¹å™¨å®‰å…¨æ‰«æ
    runs-on: ubuntu-latest
    if: github.event_name == 'push' || github.event_name == 'schedule'

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½® Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: æ„å»ºæµ‹è¯•é•œåƒ
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./deployments/Dockerfile
          load: true
          tags: domain-max:security-test
          cache-from: type=gha
          cache-to: type=gha,mode=max

      # Trivy æ¼æ´æ‰«æ
      - name: Trivy æ¼æ´æ‰«æ
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: "domain-max:security-test"
          format: "sarif"
          output: "trivy-results.sarif"

      - name: ä¸Šä¼  Trivy æ‰«æç»“æœ
        uses: github/codeql-action/upload-sarif@v2
        if: always()
        with:
          sarif_file: "trivy-results.sarif"

      # Anchore å®¹å™¨å®‰å…¨æ‰«æ
      - name: Anchore å®¹å™¨æ‰«æ
        uses: anchore/scan-action@v3
        id: anchore-scan
        with:
          image: "domain-max:security-test"
          fail-build: false
          severity-cutoff: high

      - name: ä¸Šä¼  Anchore æ‰«æç»“æœ
        uses: github/codeql-action/upload-sarif@v2
        if: always()
        with:
          sarif_file: ${{ steps.anchore-scan.outputs.sarif }}

      # Grype æ¼æ´æ‰«æ
      - name: Grype æ¼æ´æ‰«æ
        uses: anchore/grype-action@v1
        with:
          image: "domain-max:security-test"
          fail-build: false
          severity-cutoff: high

  # ===== åŸºç¡€è®¾æ–½å®‰å…¨æ‰«æ =====
  infrastructure-security-scan:
    name: åŸºç¡€è®¾æ–½å®‰å…¨æ‰«æ
    runs-on: ubuntu-latest

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      # Dockerfile å®‰å…¨æ£€æŸ¥
      - name: Hadolint Dockerfile æ£€æŸ¥
        uses: hadolint/hadolint-action@v3.1.0
        with:
          dockerfile: deployments/Dockerfile
          format: sarif
          output-file: hadolint-results.sarif

      - name: ä¸Šä¼  Hadolint ç»“æœ
        uses: github/codeql-action/upload-sarif@v2
        if: always()
        with:
          sarif_file: hadolint-results.sarif

      # Docker Compose å®‰å…¨æ£€æŸ¥
      - name: Docker Compose å®‰å…¨æ£€æŸ¥
        run: |
          # æ£€æŸ¥æ•æ„Ÿä¿¡æ¯æš´éœ²
          if grep -r "password.*=" deployments/docker-compose.yml | grep -v "\${"; then
            echo "è­¦å‘Š: Docker Compose æ–‡ä»¶ä¸­å‘ç°ç¡¬ç¼–ç å¯†ç "
            exit 1
          fi

          # æ£€æŸ¥ç‰¹æƒå®¹å™¨
          if grep -r "privileged.*true" deployments/docker-compose.yml; then
            echo "è­¦å‘Š: å‘ç°ç‰¹æƒå®¹å™¨é…ç½®"
            exit 1
          fi

      # Kubernetes é…ç½®å®‰å…¨æ£€æŸ¥ (å¦‚æœæœ‰çš„è¯)
      - name: Kubesec å®‰å…¨æ£€æŸ¥
        if: hashFiles('k8s/**/*.yaml') != ''
        run: |
          curl -sSX POST --data-binary @k8s/deployment.yaml https://v2.kubesec.io/scan

      # Terraform å®‰å…¨æ£€æŸ¥ (å¦‚æœæœ‰çš„è¯)
      - name: tfsec Terraform å®‰å…¨æ£€æŸ¥
        if: hashFiles('**/*.tf') != ''
        uses: aquasecurity/tfsec-action@v1.0.0
        with:
          soft_fail: true

  # ===== SAST æ‰«æ =====
  sast-scan:
    name: é™æ€åº”ç”¨å®‰å…¨æµ‹è¯•
    runs-on: ubuntu-latest

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # CodeQL åˆ†æ
      - name: åˆå§‹åŒ– CodeQL
        uses: github/codeql-action/init@v2
        with:
          languages: go, javascript

      - name: è‡ªåŠ¨æ„å»º
        uses: github/codeql-action/autobuild@v2

      - name: æ‰§è¡Œ CodeQL åˆ†æ
        uses: github/codeql-action/analyze@v2

      # Semgrep é™æ€åˆ†æ
      - name: Semgrep æ‰«æ
        uses: returntocorp/semgrep-action@v1
        with:
          publishToken: ${{ secrets.SEMGREP_APP_TOKEN }}
          publishDeployment: true
          generateSarif: "1"

      - name: ä¸Šä¼  Semgrep ç»“æœ
        uses: github/codeql-action/upload-sarif@v2
        if: always()
        with:
          sarif_file: semgrep.sarif

  # ===== ç”Ÿæˆå®‰å…¨æŠ¥å‘Š =====
  security-report:
    name: ç”Ÿæˆå®‰å…¨æŠ¥å‘Š
    runs-on: ubuntu-latest
    needs:
      [
        code-security-scan,
        dependency-security-scan,
        container-security-scan,
        infrastructure-security-scan,
        sast-scan,
      ]
    if: always()

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: ç”Ÿæˆå®‰å…¨æŠ¥å‘Š
        run: |
          echo "# ğŸ›¡ï¸ Domain MAX å®‰å…¨æ‰«ææŠ¥å‘Š" > security-report.md
          echo "" >> security-report.md
          echo "**æ‰«ææ—¶é—´**: $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> security-report.md
          echo "**æäº¤**: \`$(git rev-parse --short HEAD)\`" >> security-report.md
          echo "**åˆ†æ”¯**: \`${{ github.ref_name }}\`" >> security-report.md
          echo "" >> security-report.md

          echo "## ğŸ“‹ æ‰«æç»“æœ" >> security-report.md
          echo "" >> security-report.md
          echo "| æ‰«æç±»å‹ | çŠ¶æ€ | è¯´æ˜ |" >> security-report.md
          echo "|---------|------|------|" >> security-report.md
          echo "| ä»£ç å®‰å…¨æ‰«æ | ${{ needs.code-security-scan.result == 'success' && 'âœ… é€šè¿‡' || 'âŒ å¤±è´¥' }} | æºä»£ç å®‰å…¨æ€§æ£€æŸ¥ |" >> security-report.md
          echo "| ä¾èµ–å®‰å…¨æ‰«æ | ${{ needs.dependency-security-scan.result == 'success' && 'âœ… é€šè¿‡' || 'âŒ å¤±è´¥' }} | ç¬¬ä¸‰æ–¹ä¾èµ–æ¼æ´æ£€æŸ¥ |" >> security-report.md
          echo "| å®¹å™¨å®‰å…¨æ‰«æ | ${{ needs.container-security-scan.result == 'success' && 'âœ… é€šè¿‡' || 'âŒ å¤±è´¥' }} | Docker é•œåƒå®‰å…¨æ£€æŸ¥ |" >> security-report.md
          echo "| åŸºç¡€è®¾æ–½æ‰«æ | ${{ needs.infrastructure-security-scan.result == 'success' && 'âœ… é€šè¿‡' || 'âŒ å¤±è´¥' }} | é…ç½®æ–‡ä»¶å®‰å…¨æ£€æŸ¥ |" >> security-report.md
          echo "| é™æ€åˆ†æ | ${{ needs.sast-scan.result == 'success' && 'âœ… é€šè¿‡' || 'âŒ å¤±è´¥' }} | é™æ€åº”ç”¨å®‰å…¨æµ‹è¯• |" >> security-report.md
          echo "" >> security-report.md

          echo "## ğŸ” è¯¦ç»†ç»“æœ" >> security-report.md
          echo "" >> security-report.md
          echo "è¯¦ç»†çš„æ‰«æç»“æœè¯·æŸ¥çœ‹ GitHub Security æ ‡ç­¾é¡µã€‚" >> security-report.md
          echo "" >> security-report.md
          echo "## ğŸ“‹ å®‰å…¨å»ºè®®" >> security-report.md
          echo "" >> security-report.md
          echo "1. å®šæœŸæ›´æ–°ä¾èµ–åŒ…åˆ°æœ€æ–°ç‰ˆæœ¬" >> security-report.md
          echo "2. åŠæ—¶ä¿®å¤å‘ç°çš„å®‰å…¨æ¼æ´" >> security-report.md
          echo "3. ä½¿ç”¨å¼ºå¯†ç å’Œå®‰å…¨çš„é…ç½®" >> security-report.md
          echo "4. å¯ç”¨æ‰€æœ‰å®‰å…¨ç‰¹æ€§å’Œé˜²æŠ¤æœºåˆ¶" >> security-report.md

      - name: ä¸Šä¼ å®‰å…¨æŠ¥å‘Š
        uses: actions/upload-artifact@v3
        with:
          name: security-report
          path: security-report.md

      - name: å‘é€å®‰å…¨æŠ¥å‘Š
        if: github.event_name == 'schedule' && secrets.SLACK_WEBHOOK_URL
        uses: 8398a7/action-slack@v3
        with:
          status: custom
          custom_payload: |
            {
              "text": "ğŸ›¡ï¸ Domain MAX å®‰å…¨æ‰«æå®Œæˆ",
              "attachments": [
                {
                  "color": "${{ contains(needs.*.result, 'failure') && 'danger' || 'good' }}",
                  "fields": [
                    {
                      "title": "æ‰«æç»“æœ",
                      "value": "${{ contains(needs.*.result, 'failure') && 'å‘ç°å®‰å…¨é—®é¢˜' || 'æœªå‘ç°ä¸¥é‡é—®é¢˜' }}",
                      "short": true
                    },
                    {
                      "title": "è¯¦ç»†æŠ¥å‘Š",
                      "value": "<${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|æŸ¥çœ‹è¯¦æƒ…>",
                      "short": true
                    }
                  ]
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
