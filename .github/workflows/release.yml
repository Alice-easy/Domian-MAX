# å‘å¸ƒå·¥ä½œæµï¼ˆé»˜è®¤ç¦ç”¨ï¼‰
name: Release

on:
  # é»˜è®¤ç¦ç”¨è‡ªåŠ¨è§¦å‘ï¼Œéœ€è¦æ‰‹åŠ¨å¯ç”¨
  # push:
  #   tags:
  #     - "v*"
  workflow_dispatch:
    inputs:
      enable_workflow:
        description: "å¯ç”¨å·¥ä½œæµï¼ˆé»˜è®¤ç¦ç”¨ï¼‰"
        required: true
        default: false
        type: boolean
      version:
        description: "å‘å¸ƒç‰ˆæœ¬å· (ä¾‹å¦‚: v1.0.0)"
        required: true
        type: string
      prerelease:
        description: "æ˜¯å¦ä¸ºé¢„å‘å¸ƒç‰ˆæœ¬"
        required: false
        default: false
        type: boolean

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  # ===== ç‰ˆæœ¬éªŒè¯ =====
  validate-release:
    name: éªŒè¯å‘å¸ƒ
    runs-on: ubuntu-latest
    if: ${{ inputs.enable_workflow == true }}
    outputs:
      version: ${{ steps.version.outputs.version }}
      is-prerelease: ${{ steps.version.outputs.is-prerelease }}

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: éªŒè¯ç‰ˆæœ¬å·
        id: version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            VERSION="${{ inputs.version }}"
            IS_PRERELEASE="${{ inputs.prerelease }}"
          else
            VERSION="${GITHUB_REF#refs/tags/}"
            # æ£€æŸ¥æ˜¯å¦ä¸ºé¢„å‘å¸ƒç‰ˆæœ¬ (åŒ…å« alpha, beta, rc)
            if echo "$VERSION" | grep -qE "(alpha|beta|rc)"; then
              IS_PRERELEASE="true"
            else
              IS_PRERELEASE="false"
            fi
          fi

          # éªŒè¯ç‰ˆæœ¬å·æ ¼å¼
          if ! echo "$VERSION" | grep -qE "^v[0-9]+\.[0-9]+\.[0-9]+"; then
            echo "é”™è¯¯: ç‰ˆæœ¬å·æ ¼å¼ä¸æ­£ç¡® ($VERSION)"
            echo "æ­£ç¡®æ ¼å¼: v1.0.0"
            exit 1
          fi

          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "is-prerelease=$IS_PRERELEASE" >> $GITHUB_OUTPUT
          echo "å‘å¸ƒç‰ˆæœ¬: $VERSION (é¢„å‘å¸ƒ: $IS_PRERELEASE)"

      - name: æ£€æŸ¥å˜æ›´æ—¥å¿—
        run: |
          if [ ! -f CHANGELOG.md ]; then
            echo "è­¦å‘Š: æœªæ‰¾åˆ° CHANGELOG.md æ–‡ä»¶"
          elif ! grep -q "${{ steps.version.outputs.version }}" CHANGELOG.md; then
            echo "è­¦å‘Š: CHANGELOG.md ä¸­æœªæ‰¾åˆ°ç‰ˆæœ¬ ${{ steps.version.outputs.version }} çš„è®°å½•"
          fi

  # ===== è¿è¡Œå®Œæ•´æµ‹è¯• =====
  full-test-suite:
    name: å®Œæ•´æµ‹è¯•å¥—ä»¶
    uses: ./.github/workflows/ci-cd.yml
    with:
      skip_tests: false
    secrets: inherit

  # ===== æ„å»ºå‘å¸ƒé•œåƒ =====
  build-release:
    name: æ„å»ºå‘å¸ƒé•œåƒ
    runs-on: ubuntu-latest
    needs: [validate-release, full-test-suite]
    outputs:
      image-digest: ${{ steps.build.outputs.digest }}
      image-tags: ${{ steps.meta.outputs.tags }}

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½® Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: ç™»å½•åˆ°å®¹å™¨æ³¨å†Œè¡¨
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: ç”Ÿæˆé•œåƒå…ƒæ•°æ®
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=semver,pattern={{version}},value=${{ needs.validate-release.outputs.version }}
            type=semver,pattern={{major}}.{{minor}},value=${{ needs.validate-release.outputs.version }}
            type=semver,pattern={{major}},value=${{ needs.validate-release.outputs.version }}
            type=raw,value=stable,enable={{is_default_branch}}

      - name: æ„å»ºå¹¶æ¨é€å‘å¸ƒé•œåƒ
        id: build
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./deployments/Dockerfile
          platforms: linux/amd64,linux/arm64
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            VERSION=${{ needs.validate-release.outputs.version }}
            BUILDTIME=${{ github.event.repository.updated_at }}

  # ===== å®‰å…¨æ‰«æ =====
  security-scan:
    name: å‘å¸ƒç‰ˆæœ¬å®‰å…¨æ‰«æ
    runs-on: ubuntu-latest
    needs: build-release

    steps:
      - name: è¿è¡Œ Trivy å®‰å…¨æ‰«æ
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ fromJSON(needs.build-release.outputs.image-tags)[0] }}
          format: "table"
          exit-code: "1"
          severity: "CRITICAL,HIGH"

  # ===== ç”Ÿæˆå‘å¸ƒè¯´æ˜ =====
  generate-release-notes:
    name: ç”Ÿæˆå‘å¸ƒè¯´æ˜
    runs-on: ubuntu-latest
    needs: validate-release
    outputs:
      release-notes: ${{ steps.notes.outputs.notes }}

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ç”Ÿæˆå‘å¸ƒè¯´æ˜
        id: notes
        run: |
          VERSION="${{ needs.validate-release.outputs.version }}"

          # æŸ¥æ‰¾ä¸Šä¸€ä¸ªæ ‡ç­¾
          PREV_TAG=$(git describe --abbrev=0 --tags --exclude="$VERSION" 2>/dev/null || echo "")

          echo "## ğŸš€ Domain MAX $VERSION" > release-notes.md
          echo "" >> release-notes.md

          # å¦‚æœæœ‰ä¸Šä¸€ä¸ªæ ‡ç­¾ï¼Œç”Ÿæˆå˜æ›´æ—¥å¿—
          if [ -n "$PREV_TAG" ]; then
            echo "### ğŸ“‹ å˜æ›´å†…å®¹" >> release-notes.md
            echo "" >> release-notes.md
            
            # è·å–æäº¤ä¿¡æ¯
            git log --pretty=format:"- %s" "$PREV_TAG"..HEAD >> release-notes.md
            echo "" >> release-notes.md
          fi

          # æ·»åŠ å‘å¸ƒä¿¡æ¯
          echo "### ğŸ“¦ å‘å¸ƒä¿¡æ¯" >> release-notes.md
          echo "" >> release-notes.md
          echo "- **ç‰ˆæœ¬**: $VERSION" >> release-notes.md
          echo "- **å‘å¸ƒæ—¶é—´**: $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> release-notes.md
          echo "- **æäº¤**: \`$(git rev-parse --short HEAD)\`" >> release-notes.md
          echo "" >> release-notes.md

          # æ·»åŠ éƒ¨ç½²è¯´æ˜
          echo "### ğŸš€ éƒ¨ç½²è¯´æ˜" >> release-notes.md
          echo "" >> release-notes.md
          echo "**Docker é•œåƒ**:" >> release-notes.md
          echo "\`\`\`bash" >> release-notes.md
          echo "docker pull ghcr.io/${{ github.repository }}:$VERSION" >> release-notes.md
          echo "\`\`\`" >> release-notes.md
          echo "" >> release-notes.md

          echo "**å¿«é€Ÿéƒ¨ç½²**:" >> release-notes.md
          echo "\`\`\`bash" >> release-notes.md
          echo "# ä¸‹è½½æœ€æ–°ç‰ˆæœ¬" >> release-notes.md
          echo "wget https://github.com/${{ github.repository }}/archive/$VERSION.tar.gz" >> release-notes.md
          echo "tar -xzf $VERSION.tar.gz" >> release-notes.md
          echo "cd domain-max-*/" >> release-notes.md
          echo "" >> release-notes.md
          echo "# éƒ¨ç½²" >> release-notes.md
          echo "./scripts/deploy-complete.sh" >> release-notes.md
          echo "\`\`\`" >> release-notes.md
          echo "" >> release-notes.md

          # æ·»åŠ å‡çº§è¯´æ˜
          echo "### â¬†ï¸ å‡çº§è¯´æ˜" >> release-notes.md
          echo "" >> release-notes.md
          echo "å¦‚æœä»æ—§ç‰ˆæœ¬å‡çº§ï¼Œè¯·æŒ‰ç…§ä»¥ä¸‹æ­¥éª¤æ“ä½œï¼š" >> release-notes.md
          echo "" >> release-notes.md
          echo "1. å¤‡ä»½æ•°æ®" >> release-notes.md
          echo "2. åœæ­¢æœåŠ¡: \`docker-compose down\`" >> release-notes.md
          echo "3. æ‹‰å–æ–°é•œåƒ: \`docker-compose pull\`" >> release-notes.md
          echo "4. å¯åŠ¨æœåŠ¡: \`docker-compose up -d\`" >> release-notes.md
          echo "" >> release-notes.md

          # æ·»åŠ æ”¯æŒä¿¡æ¯
          echo "### ğŸ†˜ è·å–å¸®åŠ©" >> release-notes.md
          echo "" >> release-notes.md
          echo "- ğŸ“– [éƒ¨ç½²æ–‡æ¡£](docs/deployment-guide.md)" >> release-notes.md
          echo "- ğŸ› [é—®é¢˜åé¦ˆ](https://github.com/${{ github.repository }}/issues)" >> release-notes.md
          echo "- ğŸ’¬ [è®¨è®ºåŒº](https://github.com/${{ github.repository }}/discussions)" >> release-notes.md

          # è¾“å‡ºåˆ° GitHub Actions
          {
            echo 'notes<<EOF'
            cat release-notes.md
            echo EOF
          } >> $GITHUB_OUTPUT

      - name: ä¸Šä¼ å‘å¸ƒè¯´æ˜
        uses: actions/upload-artifact@v3
        with:
          name: release-notes
          path: release-notes.md

  # ===== åˆ›å»º GitHub Release =====
  create-release:
    name: åˆ›å»º GitHub Release
    runs-on: ubuntu-latest
    needs:
      [validate-release, build-release, security-scan, generate-release-notes]
    outputs:
      release-id: ${{ steps.release.outputs.id }}
      release-url: ${{ steps.release.outputs.html_url }}

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: åˆ›å»º Release
        id: release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ needs.validate-release.outputs.version }}
          release_name: Domain MAX ${{ needs.validate-release.outputs.version }}
          body: ${{ needs.generate-release-notes.outputs.release-notes }}
          draft: false
          prerelease: ${{ needs.validate-release.outputs.is-prerelease }}

      - name: æ„å»ºæºç åŒ…
        run: |
          VERSION="${{ needs.validate-release.outputs.version }}"
          git archive --format=tar.gz --prefix=domain-max-${VERSION#v}/ HEAD > domain-max-${VERSION#v}.tar.gz
          git archive --format=zip --prefix=domain-max-${VERSION#v}/ HEAD > domain-max-${VERSION#v}.zip

      - name: ä¸Šä¼ æºç åŒ…
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.release.outputs.upload_url }}
          asset_path: ./domain-max-${{ needs.validate-release.outputs.version }}.tar.gz
          asset_name: domain-max-${{ needs.validate-release.outputs.version }}.tar.gz
          asset_content_type: application/gzip

      - name: ä¸Šä¼ æºç  ZIP
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.release.outputs.upload_url }}
          asset_path: ./domain-max-${{ needs.validate-release.outputs.version }}.zip
          asset_name: domain-max-${{ needs.validate-release.outputs.version }}.zip
          asset_content_type: application/zip

  # ===== éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ =====
  deploy-production:
    name: éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ
    runs-on: ubuntu-latest
    needs: [validate-release, create-release]
    if: needs.validate-release.outputs.is-prerelease == 'false'
    environment: production

    steps:
      - name: éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ
        run: |
          echo "ğŸš€ éƒ¨ç½² Domain MAX ${{ needs.validate-release.outputs.version }} åˆ°ç”Ÿäº§ç¯å¢ƒ"
          # è¿™é‡Œæ·»åŠ ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²é€»è¾‘

      - name: éªŒè¯éƒ¨ç½²
        run: |
          echo "âœ… éªŒè¯ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²"
          # è¿è¡Œéƒ¨ç½²éªŒè¯è„šæœ¬

  # ===== å‘é€é€šçŸ¥ =====
  notify:
    name: å‘é€å‘å¸ƒé€šçŸ¥
    runs-on: ubuntu-latest
    needs: [validate-release, create-release, deploy-production]
    if: always()

    steps:
      - name: å‘é€ Slack é€šçŸ¥
        uses: 8398a7/action-slack@v3
        with:
          status: ${{ job.status }}
          fields: repo,message,commit,author,action,eventName,ref,workflow,job,took
          text: |
            ğŸ‰ Domain MAX ${{ needs.validate-release.outputs.version }} å·²å‘å¸ƒï¼

            ğŸ“¦ Release: ${{ needs.create-release.outputs.release-url }}
            ğŸš€ é•œåƒ: ghcr.io/${{ github.repository }}:${{ needs.validate-release.outputs.version }}

            ${{ needs.validate-release.outputs.is-prerelease == 'true' && 'âš ï¸ è¿™æ˜¯ä¸€ä¸ªé¢„å‘å¸ƒç‰ˆæœ¬' || 'âœ… ç”Ÿäº§ç¯å¢ƒå·²æ›´æ–°' }}
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

      - name: å‘é€é‚®ä»¶é€šçŸ¥
        if: secrets.SMTP_HOST && secrets.SMTP_USER
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: ${{ secrets.SMTP_HOST }}
          server_port: 587
          username: ${{ secrets.SMTP_USER }}
          password: ${{ secrets.SMTP_PASSWORD }}
          subject: "ğŸ‰ Domain MAX ${{ needs.validate-release.outputs.version }} å·²å‘å¸ƒ"
          to: ${{ secrets.NOTIFICATION_EMAIL }}
          from: ${{ secrets.SMTP_USER }}
          body: |
            Domain MAX æ–°ç‰ˆæœ¬å·²å‘å¸ƒï¼

            ç‰ˆæœ¬: ${{ needs.validate-release.outputs.version }}
            å‘å¸ƒé¡µé¢: ${{ needs.create-release.outputs.release-url }}

            æ„Ÿè°¢æ‚¨ä½¿ç”¨ Domain MAXï¼
