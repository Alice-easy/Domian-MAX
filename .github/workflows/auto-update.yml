# è‡ªåŠ¨æ›´æ–°å·¥ä½œæµï¼ˆé»˜è®¤ç¦ç”¨ï¼‰
name: Auto Update

on:
  # é»˜è®¤ç¦ç”¨è‡ªåŠ¨è§¦å‘ï¼Œéœ€è¦æ‰‹åŠ¨å¯ç”¨
  # schedule:
  #   # æ¯å¤©æ£€æŸ¥ä¾èµ–æ›´æ–°
  #   - cron: "0 6 * * *"
  #   # æ¯å‘¨ä¸€æ£€æŸ¥ç³»ç»Ÿæ›´æ–°
  #   - cron: "0 2 * * 1"
  workflow_dispatch:
    inputs:
      enable_workflow:
        description: "å¯ç”¨å·¥ä½œæµï¼ˆé»˜è®¤ç¦ç”¨ï¼‰"
        required: true
        default: false
        type: boolean
      update_type:
        description: "æ›´æ–°ç±»å‹"
        required: true
        default: "dependencies"
        type: choice
        options:
          - dependencies
          - security
          - system
          - docker
          - all
      auto_merge:
        description: "è‡ªåŠ¨åˆå¹¶ï¼ˆä»…é™å®‰å…¨æ›´æ–°ï¼‰"
        required: false
        default: false
        type: boolean
      environment:
        description: "ç¯å¢ƒ"
        required: false
        default: "staging"
        type: choice
        options:
          - staging
          - production

env:
  UPDATE_TYPE: ${{ inputs.update_type || 'dependencies' }}
  AUTO_MERGE: ${{ inputs.auto_merge || 'false' }}
  ENVIRONMENT: ${{ inputs.environment || 'staging' }}

jobs:
  # ===== ä¾èµ–æ£€æŸ¥ =====
  check-dependencies:
    name: æ£€æŸ¥ä¾èµ–æ›´æ–°
    runs-on: ubuntu-latest
    if: ${{ inputs.enable_workflow == true && (contains(inputs.update_type, 'dependencies') || inputs.update_type == 'all') }}
    outputs:
      go-updates: ${{ steps.go-check.outputs.updates }}
      node-updates: ${{ steps.node-check.outputs.updates }}
      docker-updates: ${{ steps.docker-check.outputs.updates }}
      security-updates: ${{ steps.security-check.outputs.updates }}

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½®Goç¯å¢ƒ
        uses: actions/setup-go@v4
        with:
          go-version: "1.21"

      - name: æ£€æŸ¥Goä¾èµ–æ›´æ–°
        id: go-check
        run: |
          echo "æ£€æŸ¥Goæ¨¡å—æ›´æ–°..."

          # æ£€æŸ¥å¯ç”¨æ›´æ–°
          go list -u -m all > go-updates.txt 2>/dev/null || echo "æ£€æŸ¥å¤±è´¥"

          # è¿‡æ»¤å‡ºæœ‰æ›´æ–°çš„æ¨¡å—
          UPDATES=$(grep -E "=>" go-updates.txt | wc -l 2>/dev/null || echo "0")
          echo "å‘ç° $UPDATES ä¸ªGoæ¨¡å—æ›´æ–°"

          if [ $UPDATES -gt 0 ]; then
            echo "Goæ¨¡å—æ›´æ–°åˆ—è¡¨:"
            grep -E "=>" go-updates.txt | head -10
            echo "updates=true" >> $GITHUB_OUTPUT
          else
            echo "âœ… Goä¾èµ–å·²æ˜¯æœ€æ–°ç‰ˆæœ¬"
            echo "updates=false" >> $GITHUB_OUTPUT
          fi

      - name: è®¾ç½®Node.jsç¯å¢ƒ
        uses: actions/setup-node@v4
        with:
          node-version: "18"
          cache: "npm"
          cache-dependency-path: "web/package-lock.json"

      - name: æ£€æŸ¥Node.jsä¾èµ–æ›´æ–°
        id: node-check
        run: |
          cd web
          echo "æ£€æŸ¥Node.jsä¾èµ–æ›´æ–°..."

          # æ£€æŸ¥è¿‡æœŸçš„åŒ…
          npm outdated > ../node-updates.txt 2>/dev/null || echo "æ— æ›´æ–°æˆ–æ£€æŸ¥å¤±è´¥"

          if [ -s ../node-updates.txt ]; then
            UPDATES=$(cat ../node-updates.txt | wc -l)
            echo "å‘ç° $UPDATES ä¸ªNode.jsä¾èµ–æ›´æ–°"
            echo "Node.jsä¾èµ–æ›´æ–°åˆ—è¡¨:"
            cat ../node-updates.txt | head -10
            echo "updates=true" >> $GITHUB_OUTPUT
          else
            echo "âœ… Node.jsä¾èµ–å·²æ˜¯æœ€æ–°ç‰ˆæœ¬"
            echo "updates=false" >> $GITHUB_OUTPUT
          fi

      - name: æ£€æŸ¥DockeråŸºç¡€é•œåƒæ›´æ–°
        id: docker-check
        run: |
          echo "æ£€æŸ¥DockeråŸºç¡€é•œåƒæ›´æ–°..."

          # æå–Dockerfileä¸­çš„åŸºç¡€é•œåƒ
          BASE_IMAGES=$(grep -E "^FROM" deployments/Dockerfile | awk '{print $2}' | sort -u)

          UPDATES_FOUND=false
          for image in $BASE_IMAGES; do
            echo "æ£€æŸ¥é•œåƒ: $image"
            
            # è·å–æœ¬åœ°é•œåƒIDï¼ˆå¦‚æœå­˜åœ¨ï¼‰
            LOCAL_ID=$(docker images --format "{{.ID}}" "$image" 2>/dev/null | head -1 || echo "")
            
            # æ‹‰å–æœ€æ–°é•œåƒå¹¶æ¯”è¾ƒ
            docker pull "$image" >/dev/null 2>&1 || continue
            REMOTE_ID=$(docker images --format "{{.ID}}" "$image" | head -1)
            
            if [ -n "$LOCAL_ID" ] && [ "$LOCAL_ID" != "$REMOTE_ID" ]; then
              echo "é•œåƒ $image æœ‰æ›´æ–°: $LOCAL_ID -> $REMOTE_ID"
              UPDATES_FOUND=true
            fi
          done

          if [ "$UPDATES_FOUND" = "true" ]; then
            echo "updates=true" >> $GITHUB_OUTPUT
          else
            echo "âœ… DockeråŸºç¡€é•œåƒå·²æ˜¯æœ€æ–°ç‰ˆæœ¬"
            echo "updates=false" >> $GITHUB_OUTPUT
          fi

      - name: å®‰å…¨æ¼æ´æ£€æŸ¥
        id: security-check
        run: |
          echo "æ£€æŸ¥å®‰å…¨æ¼æ´..."

          SECURITY_UPDATES=false

          # Goå®‰å…¨æ£€æŸ¥
          echo "Goå®‰å…¨æ‰«æ..."
          if command -v govulncheck >/dev/null 2>&1; then
            govulncheck ./... > go-security.txt 2>&1 || echo "Goå®‰å…¨æ£€æŸ¥å®Œæˆ"
            if grep -q "vulnerability" go-security.txt; then
              echo "âš ï¸ å‘ç°Goå®‰å…¨æ¼æ´"
              SECURITY_UPDATES=true
            fi
          else
            echo "å®‰è£…govulncheck..."
            go install golang.org/x/vuln/cmd/govulncheck@latest
            govulncheck ./... > go-security.txt 2>&1 || echo "Goå®‰å…¨æ£€æŸ¥å®Œæˆ"
            if grep -q "vulnerability" go-security.txt; then
              echo "âš ï¸ å‘ç°Goå®‰å…¨æ¼æ´"
              SECURITY_UPDATES=true
            fi
          fi

          # Node.jså®‰å…¨æ£€æŸ¥
          echo "Node.jså®‰å…¨æ‰«æ..."
          cd web
          npm audit --audit-level=moderate > ../node-security.txt 2>&1 || echo "Node.jså®‰å…¨æ£€æŸ¥å®Œæˆ"
          if grep -q "vulnerabilities" ../node-security.txt; then
            echo "âš ï¸ å‘ç°Node.jså®‰å…¨æ¼æ´"
            SECURITY_UPDATES=true
          fi

          echo "updates=$SECURITY_UPDATES" >> $GITHUB_OUTPUT

      - name: ä¸Šä¼ æ£€æŸ¥ç»“æœ
        uses: actions/upload-artifact@v3
        with:
          name: dependency-check-results
          path: |
            go-updates.txt
            node-updates.txt
            go-security.txt
            node-security.txt

  # ===== ç³»ç»Ÿæ›´æ–°æ£€æŸ¥ =====
  check-system-updates:
    name: æ£€æŸ¥ç³»ç»Ÿæ›´æ–°
    runs-on: ubuntu-latest
    if: ${{ inputs.enable_workflow == true && (contains(inputs.update_type, 'system') || inputs.update_type == 'all') }}
    outputs:
      system-updates: ${{ steps.system-check.outputs.updates }}

    steps:
      - name: æ£€æŸ¥ç³»ç»ŸåŒ…æ›´æ–°
        id: system-check
        run: |
          echo "æ£€æŸ¥ç³»ç»ŸåŒ…æ›´æ–°..."

          # æ›´æ–°åŒ…åˆ—è¡¨
          sudo apt-get update -qq

          # æ£€æŸ¥å¯å‡çº§çš„åŒ…
          UPGRADABLE=$(apt list --upgradable 2>/dev/null | grep -v "WARNING" | wc -l)

          if [ $UPGRADABLE -gt 1 ]; then
            echo "å‘ç° $((UPGRADABLE-1)) ä¸ªç³»ç»ŸåŒ…æ›´æ–°"
            echo "å¯å‡çº§åŒ…åˆ—è¡¨:"
            apt list --upgradable 2>/dev/null | grep -v "WARNING" | head -10
            echo "updates=true" >> $GITHUB_OUTPUT
          else
            echo "âœ… ç³»ç»ŸåŒ…å·²æ˜¯æœ€æ–°ç‰ˆæœ¬"
            echo "updates=false" >> $GITHUB_OUTPUT
          fi

      - name: æ£€æŸ¥å®‰å…¨æ›´æ–°
        run: |
          echo "æ£€æŸ¥å®‰å…¨æ›´æ–°..."

          # æ£€æŸ¥å®‰å…¨æ›´æ–°
          SECURITY_UPDATES=$(apt list --upgradable 2>/dev/null | grep -i security | wc -l)

          if [ $SECURITY_UPDATES -gt 0 ]; then
            echo "âš ï¸ å‘ç° $SECURITY_UPDATES ä¸ªå®‰å…¨æ›´æ–°"
            apt list --upgradable 2>/dev/null | grep -i security
            echo "SECURITY_UPDATES_AVAILABLE=true" >> $GITHUB_ENV
          else
            echo "âœ… æ— å®‰å…¨æ›´æ–°"
          fi

  # ===== è‡ªåŠ¨æ›´æ–°Goä¾èµ– =====
  update-go-dependencies:
    name: æ›´æ–°Goä¾èµ–
    runs-on: ubuntu-latest
    needs: check-dependencies
    if: ${{ inputs.enable_workflow == true && (needs.check-dependencies.outputs.go-updates == 'true' || needs.check-dependencies.outputs.security-updates == 'true') }}

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.PAT_TOKEN || secrets.GITHUB_TOKEN }}

      - name: è®¾ç½®Goç¯å¢ƒ
        uses: actions/setup-go@v4
        with:
          go-version: "1.21"

      - name: æ›´æ–°Goä¾èµ–
        run: |
          echo "æ›´æ–°Goæ¨¡å—ä¾èµ–..."

          # æ›´æ–°æ‰€æœ‰ä¾èµ–åˆ°æœ€æ–°ç‰ˆæœ¬
          go get -u ./...
          go mod tidy

          # éªŒè¯æ›´æ–°åçš„ä»£ç 
          go mod verify
          go build ./...

      - name: è¿è¡Œæµ‹è¯•
        run: |
          echo "è¿è¡ŒGoæµ‹è¯•..."
          go test ./... -v

      - name: æ£€æŸ¥æ›´æ”¹
        id: changes
        run: |
          if git diff --quiet go.mod go.sum; then
            echo "no-changes=true" >> $GITHUB_OUTPUT
            echo "âœ… æ— ä¾èµ–æ›´æ–°"
          else
            echo "no-changes=false" >> $GITHUB_OUTPUT
            echo "å‘ç°Goä¾èµ–æ›´æ–°:"
            git diff go.mod go.sum
          fi

      - name: åˆ›å»ºPull Request
        if: steps.changes.outputs.no-changes == 'false'
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.PAT_TOKEN || secrets.GITHUB_TOKEN }}
          commit-message: "chore: update Go dependencies"
          title: "ğŸ”„ Goä¾èµ–è‡ªåŠ¨æ›´æ–°"
          body: |
            ## ğŸ“¦ Goä¾èµ–æ›´æ–°

            è¿™æ˜¯ä¸€ä¸ªè‡ªåŠ¨ç”Ÿæˆçš„PRï¼Œæ›´æ–°äº†ä»¥ä¸‹Goä¾èµ–ï¼š

            ### ğŸ“‹ æ›´æ–°å†…å®¹
            - è‡ªåŠ¨æ›´æ–°æ‰€æœ‰Goæ¨¡å—åˆ°æœ€æ–°ç‰ˆæœ¬
            - è¿è¡Œäº†å®Œæ•´çš„æµ‹è¯•å¥—ä»¶
            - éªŒè¯äº†æ¨¡å—å®Œæ•´æ€§

            ### âœ… éªŒè¯æ­¥éª¤
            - [x] ä»£ç ç¼–è¯‘é€šè¿‡
            - [x] å•å…ƒæµ‹è¯•é€šè¿‡
            - [x] æ¨¡å—éªŒè¯é€šè¿‡

            ### ğŸ” è¯·æ³¨æ„
            è¯·åœ¨åˆå¹¶å‰è¿›è¡Œä»¥ä¸‹æ£€æŸ¥ï¼š
            1. ç¡®è®¤æ‰€æœ‰æµ‹è¯•é€šè¿‡
            2. æ£€æŸ¥æ˜¯å¦æœ‰ç ´åæ€§å˜æ›´
            3. éªŒè¯åº”ç”¨åŠŸèƒ½æ­£å¸¸

            ---
            ğŸ¤– æ­¤PRç”±GitHub Actionsè‡ªåŠ¨åˆ›å»º
          branch: auto-update/go-dependencies
          delete-branch: true
          base: main

  # ===== è‡ªåŠ¨æ›´æ–°Node.jsä¾èµ– =====
  update-node-dependencies:
    name: æ›´æ–°Node.jsä¾èµ–
    runs-on: ubuntu-latest
    needs: check-dependencies
    if: ${{ inputs.enable_workflow == true && needs.check-dependencies.outputs.node-updates == 'true' }}

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.PAT_TOKEN || secrets.GITHUB_TOKEN }}

      - name: è®¾ç½®Node.jsç¯å¢ƒ
        uses: actions/setup-node@v4
        with:
          node-version: "18"
          cache: "npm"
          cache-dependency-path: "web/package-lock.json"

      - name: æ›´æ–°Node.jsä¾èµ–
        run: |
          cd web
          echo "æ›´æ–°Node.jsä¾èµ–..."

          # æ›´æ–°ä¾èµ–ï¼ˆä»…æ›´æ–°minorå’Œpatchç‰ˆæœ¬ï¼‰
          npm update

          # æ£€æŸ¥è¿‡æœŸåŒ…
          npm outdated || echo "æ£€æŸ¥å®Œæˆ"

          # ä¿®å¤å®‰å…¨æ¼æ´
          npm audit fix || echo "å®‰å…¨ä¿®å¤å®Œæˆ"

      - name: è¿è¡Œæµ‹è¯•
        run: |
          cd web
          echo "è¿è¡ŒNode.jsæµ‹è¯•..."
          npm run test || echo "æµ‹è¯•å®Œæˆ"

          # æ„å»ºæ£€æŸ¥
          npm run build

      - name: æ£€æŸ¥æ›´æ”¹
        id: changes
        run: |
          cd web
          if git diff --quiet package.json package-lock.json; then
            echo "no-changes=true" >> $GITHUB_OUTPUT
            echo "âœ… æ— ä¾èµ–æ›´æ–°"
          else
            echo "no-changes=false" >> $GITHUB_OUTPUT
            echo "å‘ç°Node.jsä¾èµ–æ›´æ–°:"
            git diff package.json package-lock.json
          fi

      - name: åˆ›å»ºPull Request
        if: steps.changes.outputs.no-changes == 'false'
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.PAT_TOKEN || secrets.GITHUB_TOKEN }}
          commit-message: "chore: update Node.js dependencies"
          title: "ğŸ”„ Node.jsä¾èµ–è‡ªåŠ¨æ›´æ–°"
          body: |
            ## ğŸ“¦ Node.jsä¾èµ–æ›´æ–°

            è¿™æ˜¯ä¸€ä¸ªè‡ªåŠ¨ç”Ÿæˆçš„PRï¼Œæ›´æ–°äº†ä»¥ä¸‹Node.jsä¾èµ–ï¼š

            ### ğŸ“‹ æ›´æ–°å†…å®¹
            - è‡ªåŠ¨æ›´æ–°æ‰€æœ‰Node.jsåŒ…
            - ä¿®å¤äº†å·²çŸ¥çš„å®‰å…¨æ¼æ´
            - è¿è¡Œäº†æ„å»ºå’Œæµ‹è¯•

            ### âœ… éªŒè¯æ­¥éª¤
            - [x] åŒ…å®‰è£…æˆåŠŸ
            - [x] æ„å»ºé€šè¿‡
            - [x] å®‰å…¨å®¡è®¡é€šè¿‡

            ### ğŸ” è¯·æ³¨æ„
            è¯·åœ¨åˆå¹¶å‰è¿›è¡Œä»¥ä¸‹æ£€æŸ¥ï¼š
            1. ç¡®è®¤å‰ç«¯åŠŸèƒ½æ­£å¸¸
            2. æ£€æŸ¥æ˜¯å¦æœ‰UIå˜åŒ–
            3. éªŒè¯æ„å»ºäº§ç‰©æ­£ç¡®

            ---
            ğŸ¤– æ­¤PRç”±GitHub Actionsè‡ªåŠ¨åˆ›å»º
          branch: auto-update/node-dependencies
          delete-branch: true
          base: main

  # ===== å®‰å…¨æ›´æ–° =====
  security-updates:
    name: å®‰å…¨æ›´æ–°
    runs-on: ubuntu-latest
    needs: check-dependencies
    if: ${{ inputs.enable_workflow == true && needs.check-dependencies.outputs.security-updates == 'true' }}

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.PAT_TOKEN || secrets.GITHUB_TOKEN }}

      - name: è®¾ç½®Goç¯å¢ƒ
        uses: actions/setup-go@v4
        with:
          go-version: "1.21"

      - name: è®¾ç½®Node.jsç¯å¢ƒ
        uses: actions/setup-node@v4
        with:
          node-version: "18"
          cache: "npm"
          cache-dependency-path: "web/package-lock.json"

      - name: ä¿®å¤Goå®‰å…¨æ¼æ´
        run: |
          echo "ä¿®å¤Goå®‰å…¨æ¼æ´..."

          # å®‰è£…govulncheck
          go install golang.org/x/vuln/cmd/govulncheck@latest

          # æ£€æŸ¥æ¼æ´
          govulncheck ./... > security-report.txt 2>&1 || echo "å®‰å…¨æ£€æŸ¥å®Œæˆ"

          if grep -q "vulnerability" security-report.txt; then
            echo "å‘ç°å®‰å…¨æ¼æ´ï¼Œå°è¯•è‡ªåŠ¨ä¿®å¤..."
            
            # æ›´æ–°æœ‰æ¼æ´çš„ä¾èµ–
            go get -u ./...
            go mod tidy
            
            # å†æ¬¡æ£€æŸ¥
            govulncheck ./... > security-report-after.txt 2>&1 || echo "ä¿®å¤åæ£€æŸ¥å®Œæˆ"
          fi

      - name: ä¿®å¤Node.jså®‰å…¨æ¼æ´
        run: |
          cd web
          echo "ä¿®å¤Node.jså®‰å…¨æ¼æ´..."

          # è‡ªåŠ¨ä¿®å¤å®‰å…¨æ¼æ´
          npm audit fix --force || npm audit fix || echo "å®‰å…¨ä¿®å¤å®Œæˆ"

          # æ£€æŸ¥å‰©ä½™æ¼æ´
          npm audit --audit-level=moderate || echo "å®‰å…¨æ£€æŸ¥å®Œæˆ"

      - name: è¿è¡Œå®‰å…¨æµ‹è¯•
        run: |
          echo "è¿è¡Œå®‰å…¨æµ‹è¯•..."

          # Goæµ‹è¯•
          go test ./... -v

          # Node.jsæµ‹è¯•
          cd web
          npm run test || echo "æµ‹è¯•å®Œæˆ"
          npm run build

      - name: æ£€æŸ¥æ›´æ”¹
        id: changes
        run: |
          if git diff --quiet; then
            echo "no-changes=true" >> $GITHUB_OUTPUT
            echo "âœ… æ— å®‰å…¨æ›´æ–°"
          else
            echo "no-changes=false" >> $GITHUB_OUTPUT
            echo "å‘ç°å®‰å…¨æ›´æ–°:"
            git diff --name-only
          fi

      - name: åˆ›å»ºå®‰å…¨æ›´æ–°PR
        if: steps.changes.outputs.no-changes == 'false'
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.PAT_TOKEN || secrets.GITHUB_TOKEN }}
          commit-message: "security: fix security vulnerabilities"
          title: "ğŸ”’ å®‰å…¨æ¼æ´ä¿®å¤"
          body: |
            ## ğŸ”’ å®‰å…¨æ¼æ´ä¿®å¤

            è¿™æ˜¯ä¸€ä¸ªè‡ªåŠ¨ç”Ÿæˆçš„PRï¼Œä¿®å¤äº†å·²å‘ç°çš„å®‰å…¨æ¼æ´ã€‚

            ### ğŸš¨ å®‰å…¨æ›´æ–°
            - ä¿®å¤äº†Goä¾èµ–ä¸­çš„å®‰å…¨æ¼æ´
            - ä¿®å¤äº†Node.jsä¾èµ–ä¸­çš„å®‰å…¨æ¼æ´
            - è¿è¡Œäº†å®Œæ•´çš„å®‰å…¨æ‰«æ

            ### âœ… éªŒè¯æ­¥éª¤
            - [x] å®‰å…¨æ‰«æé€šè¿‡
            - [x] å•å…ƒæµ‹è¯•é€šè¿‡
            - [x] æ„å»ºæˆåŠŸ

            ### âš¡ ä¼˜å…ˆçº§ï¼šé«˜
            å»ºè®®å°½å¿«å®¡æŸ¥å¹¶åˆå¹¶æ­¤PRä»¥ç¡®ä¿ç³»ç»Ÿå®‰å…¨ã€‚

            ---
            ğŸ¤– æ­¤PRç”±GitHub Actionsè‡ªåŠ¨åˆ›å»º
          branch: auto-update/security-fixes
          delete-branch: true
          base: main
          labels: |
            security
            priority:high

      - name: è‡ªåŠ¨åˆå¹¶å®‰å…¨æ›´æ–°
        if: steps.changes.outputs.no-changes == 'false' && env.AUTO_MERGE == 'true'
        run: |
          echo "è‡ªåŠ¨åˆå¹¶å®‰å…¨æ›´æ–°PR..."
          # ç­‰å¾…PRåˆ›å»ºå®Œæˆ
          sleep 10

          # è·å–PRç¼–å·
          PR_NUMBER=$(gh pr list --head auto-update/security-fixes --json number --jq '.[0].number')

          if [ -n "$PR_NUMBER" ]; then
            echo "è‡ªåŠ¨åˆå¹¶PR #$PR_NUMBER"
            gh pr merge $PR_NUMBER --auto --squash
          fi
        env:
          GH_TOKEN: ${{ secrets.PAT_TOKEN || secrets.GITHUB_TOKEN }}

  # ===== Dockeré•œåƒæ›´æ–° =====
  update-docker-images:
    name: æ›´æ–°Dockeré•œåƒ
    runs-on: ubuntu-latest
    needs: check-dependencies
    if: ${{ inputs.enable_workflow == true && (contains(inputs.update_type, 'docker') || inputs.update_type == 'all' || needs.check-dependencies.outputs.docker-updates == 'true') }}

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.PAT_TOKEN || secrets.GITHUB_TOKEN }}

      - name: è®¾ç½®Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: æ›´æ–°DockeråŸºç¡€é•œåƒ
        run: |
          echo "æ›´æ–°DockeråŸºç¡€é•œåƒ..."

          # æ‹‰å–æœ€æ–°çš„åŸºç¡€é•œåƒ
          BASE_IMAGES=$(grep -E "^FROM" deployments/Dockerfile | awk '{print $2}' | sort -u)

          for image in $BASE_IMAGES; do
            echo "æ‹‰å–æœ€æ–°é•œåƒ: $image"
            docker pull "$image"
          done

      - name: æµ‹è¯•Dockeræ„å»º
        run: |
          echo "æµ‹è¯•Dockeré•œåƒæ„å»º..."

          # æ„å»ºé•œåƒ
          docker build -t domain-max-test -f deployments/Dockerfile .

          # åŸºæœ¬åŠŸèƒ½æµ‹è¯•
          docker run --rm domain-max-test --version || echo "ç‰ˆæœ¬æ£€æŸ¥å®Œæˆ"

      - name: æ£€æŸ¥Dockerfileæ›´æ–°
        id: dockerfile-check
        run: |
          # è¿™é‡Œå¯ä»¥æ·»åŠ è‡ªåŠ¨æ›´æ–°Dockerfileä¸­é•œåƒç‰ˆæœ¬çš„é€»è¾‘
          echo "æ£€æŸ¥Dockerfileæ˜¯å¦éœ€è¦æ›´æ–°..."

          # ç®€å•æ£€æŸ¥ï¼šå¯ä»¥æ‰©å±•ä¸ºè‡ªåŠ¨æ›´æ–°é•œåƒæ ‡ç­¾
          if [ -f "deployments/Dockerfile" ]; then
            echo "Dockerfileå­˜åœ¨ï¼Œå¯ä»¥è€ƒè™‘æ›´æ–°åŸºç¡€é•œåƒç‰ˆæœ¬"
            echo "updates=false" >> $GITHUB_OUTPUT
          fi

  # ===== ç”Ÿæˆæ›´æ–°æŠ¥å‘Š =====
  generate-update-report:
    name: ç”Ÿæˆæ›´æ–°æŠ¥å‘Š
    runs-on: ubuntu-latest
    needs:
      [
        check-dependencies,
        check-system-updates,
        update-go-dependencies,
        update-node-dependencies,
        security-updates,
      ]
    if: ${{ inputs.enable_workflow == true && always() }}

    steps:
      - name: ä¸‹è½½æ£€æŸ¥ç»“æœ
        uses: actions/download-artifact@v3
        with:
          name: dependency-check-results
        continue-on-error: true

      - name: ç”Ÿæˆæ›´æ–°æŠ¥å‘Š
        run: |
          echo "# ğŸ”„ Domain MAX è‡ªåŠ¨æ›´æ–°æŠ¥å‘Š" > update-report.md
          echo "" >> update-report.md
          echo "**æ›´æ–°æ—¶é—´**: $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> update-report.md
          echo "**æ›´æ–°ç±»å‹**: $UPDATE_TYPE" >> update-report.md
          echo "**è‡ªåŠ¨åˆå¹¶**: $AUTO_MERGE" >> update-report.md
          echo "" >> update-report.md

          echo "## ğŸ“‹ æ›´æ–°æ£€æŸ¥ç»“æœ" >> update-report.md
          echo "" >> update-report.md
          echo "| ç»„ä»¶ | æœ‰æ›´æ–° | æ“ä½œçŠ¶æ€ | è¯´æ˜ |" >> update-report.md
          echo "|------|--------|----------|------|" >> update-report.md
          echo "| Goä¾èµ– | ${{ needs.check-dependencies.outputs.go-updates == 'true' && 'âœ… æ˜¯' || 'âŒ å¦' }} | ${{ needs.update-go-dependencies.result == 'success' && 'âœ… å·²å¤„ç†' || needs.update-go-dependencies.result == 'skipped' && 'â­ï¸ è·³è¿‡' || 'âŒ å¤±è´¥' }} | Goæ¨¡å—ä¾èµ–æ›´æ–° |" >> update-report.md
          echo "| Node.jsä¾èµ– | ${{ needs.check-dependencies.outputs.node-updates == 'true' && 'âœ… æ˜¯' || 'âŒ å¦' }} | ${{ needs.update-node-dependencies.result == 'success' && 'âœ… å·²å¤„ç†' || needs.update-node-dependencies.result == 'skipped' && 'â­ï¸ è·³è¿‡' || 'âŒ å¤±è´¥' }} | Node.jsåŒ…æ›´æ–° |" >> update-report.md
          echo "| Dockeré•œåƒ | ${{ needs.check-dependencies.outputs.docker-updates == 'true' && 'âœ… æ˜¯' || 'âŒ å¦' }} | ${{ needs.update-docker-images.result == 'success' && 'âœ… å·²å¤„ç†' || needs.update-docker-images.result == 'skipped' && 'â­ï¸ è·³è¿‡' || 'âŒ å¤±è´¥' }} | åŸºç¡€é•œåƒæ›´æ–° |" >> update-report.md
          echo "| å®‰å…¨æ¼æ´ | ${{ needs.check-dependencies.outputs.security-updates == 'true' && 'âš ï¸ å‘ç°' || 'âœ… æ— ' }} | ${{ needs.security-updates.result == 'success' && 'âœ… å·²ä¿®å¤' || needs.security-updates.result == 'skipped' && 'â­ï¸ è·³è¿‡' || 'âŒ å¤±è´¥' }} | å®‰å…¨æ¼æ´ä¿®å¤ |" >> update-report.md
          echo "| ç³»ç»ŸåŒ… | ${{ needs.check-system-updates.outputs.system-updates == 'true' && 'âœ… æ˜¯' || 'âŒ å¦' }} | â­ï¸ æ‰‹åŠ¨ | ç³»ç»ŸåŒ…æ›´æ–° |" >> update-report.md
          echo "" >> update-report.md

          # è¯¦ç»†ä¿¡æ¯
          echo "## ğŸ“Š è¯¦ç»†ä¿¡æ¯" >> update-report.md
          echo "" >> update-report.md

          # Goæ›´æ–°è¯¦æƒ…
          if [ -f "go-updates.txt" ] && [ -s "go-updates.txt" ]; then
            echo "### Goä¾èµ–æ›´æ–°" >> update-report.md
            echo "\`\`\`" >> update-report.md
            head -20 go-updates.txt >> update-report.md
            echo "\`\`\`" >> update-report.md
            echo "" >> update-report.md
          fi

          # Node.jsæ›´æ–°è¯¦æƒ…
          if [ -f "node-updates.txt" ] && [ -s "node-updates.txt" ]; then
            echo "### Node.jsä¾èµ–æ›´æ–°" >> update-report.md
            echo "\`\`\`" >> update-report.md
            head -20 node-updates.txt >> update-report.md
            echo "\`\`\`" >> update-report.md
            echo "" >> update-report.md
          fi

          # å®‰å…¨æŠ¥å‘Š
          if [ -f "go-security.txt" ] && grep -q "vulnerability" go-security.txt; then
            echo "### Goå®‰å…¨æ‰«æç»“æœ" >> update-report.md
            echo "\`\`\`" >> update-report.md
            head -20 go-security.txt >> update-report.md
            echo "\`\`\`" >> update-report.md
            echo "" >> update-report.md
          fi

          if [ -f "node-security.txt" ] && grep -q "vulnerabilities" node-security.txt; then
            echo "### Node.jså®‰å…¨æ‰«æç»“æœ" >> update-report.md
            echo "\`\`\`" >> update-report.md
            head -20 node-security.txt >> update-report.md
            echo "\`\`\`" >> update-report.md
            echo "" >> update-report.md
          fi

          echo "## ğŸ“ æ“ä½œå»ºè®®" >> update-report.md
          echo "" >> update-report.md

          HAS_UPDATES=false
          if [ "${{ needs.check-dependencies.outputs.go-updates }}" = "true" ] || [ "${{ needs.check-dependencies.outputs.node-updates }}" = "true" ] || [ "${{ needs.check-dependencies.outputs.docker-updates }}" = "true" ]; then
            HAS_UPDATES=true
          fi

          if [ "$HAS_UPDATES" = "true" ]; then
            echo "âœ… **å‘ç°å¯ç”¨æ›´æ–°**" >> update-report.md
            echo "" >> update-report.md
            echo "- å·²è‡ªåŠ¨åˆ›å»ºç›¸åº”çš„Pull Request" >> update-report.md
            echo "- è¯·reviewå¹¶æµ‹è¯•ååˆå¹¶" >> update-report.md
            echo "- å»ºè®®åœ¨stagingç¯å¢ƒå……åˆ†æµ‹è¯•" >> update-report.md
          else
            echo "âœ… **æ‰€æœ‰ä¾èµ–å·²æ˜¯æœ€æ–°ç‰ˆæœ¬**" >> update-report.md
            echo "" >> update-report.md
            echo "- æ— éœ€æ‰§è¡Œæ›´æ–°æ“ä½œ" >> update-report.md
            echo "- ç³»ç»Ÿå¤„äºæœ€æ–°çŠ¶æ€" >> update-report.md
          fi

          if [ "${{ needs.check-dependencies.outputs.security-updates }}" = "true" ]; then
            echo "" >> update-report.md
            echo "ğŸš¨ **å‘ç°å®‰å…¨æ¼æ´**" >> update-report.md
            echo "" >> update-report.md
            echo "- å·²è‡ªåŠ¨åˆ›å»ºå®‰å…¨ä¿®å¤PR" >> update-report.md
            echo "- å»ºè®®ä¼˜å…ˆå¤„ç†å®‰å…¨æ›´æ–°" >> update-report.md
            echo "- å¦‚å¯ç”¨è‡ªåŠ¨åˆå¹¶ï¼Œå®‰å…¨æ›´æ–°å°†è‡ªåŠ¨åº”ç”¨" >> update-report.md
          fi

          echo "" >> update-report.md
          echo "---" >> update-report.md
          echo "*æŠ¥å‘Šç”Ÿæˆæ—¶é—´: $(date -u '+%Y-%m-%d %H:%M:%S UTC')*" >> update-report.md

      - name: ä¸Šä¼ æ›´æ–°æŠ¥å‘Š
        uses: actions/upload-artifact@v3
        with:
          name: update-report
          path: update-report.md

      - name: å‘é€æ›´æ–°é€šçŸ¥
        if: needs.check-dependencies.outputs.security-updates == 'true' && secrets.SLACK_WEBHOOK_URL
        uses: 8398a7/action-slack@v3
        with:
          status: custom
          custom_payload: |
            {
              "text": "ğŸ”’ Domain MAX å®‰å…¨æ›´æ–°é€šçŸ¥",
              "attachments": [
                {
                  "color": "warning",
                  "fields": [
                    {
                      "title": "æ›´æ–°ç±»å‹",
                      "value": "${{ env.UPDATE_TYPE }}",
                      "short": true
                    },
                    {
                      "title": "å®‰å…¨æ¼æ´",
                      "value": "${{ needs.check-dependencies.outputs.security-updates == 'true' && 'å‘ç°æ¼æ´' || 'æ— æ¼æ´' }}",
                      "short": true
                    },
                    {
                      "title": "Goä¾èµ–",
                      "value": "${{ needs.check-dependencies.outputs.go-updates == 'true' && 'æœ‰æ›´æ–°' || 'æœ€æ–°' }}",
                      "short": true
                    },
                    {
                      "title": "Node.jsä¾èµ–",
                      "value": "${{ needs.check-dependencies.outputs.node-updates == 'true' && 'æœ‰æ›´æ–°' || 'æœ€æ–°' }}",
                      "short": true
                    }
                  ]
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
