# ä¾èµ–æ›´æ–°å·¥ä½œæµï¼ˆé»˜è®¤ç¦ç”¨ï¼‰
name: Dependency Updates

on:
  # é»˜è®¤ç¦ç”¨è‡ªåŠ¨è§¦å‘ï¼Œéœ€è¦æ‰‹åŠ¨å¯ç”¨
  # schedule:
  #   # æ¯å‘¨ä¸€æ—©ä¸Š 9:00 UTC æ£€æŸ¥ä¾èµ–æ›´æ–°
  #   - cron: "0 9 * * 1"
  workflow_dispatch:
    inputs:
      enable_workflow:
        description: "å¯ç”¨å·¥ä½œæµï¼ˆé»˜è®¤ç¦ç”¨ï¼‰"
        required: true
        default: false
        type: boolean
      update_type:
        description: "æ›´æ–°ç±»å‹"
        required: false
        default: "all"
        type: choice
        options:
          - go
          - node
          - all

jobs:
  # ===== Go ä¾èµ–æ›´æ–° =====
  update-go-dependencies:
    name: æ›´æ–° Go ä¾èµ–
    runs-on: ubuntu-latest
    if: ${{ inputs.enable_workflow == true && (inputs.update_type == 'go' || inputs.update_type == 'all') }}

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: è®¾ç½® Go ç¯å¢ƒ
        uses: actions/setup-go@v4
        with:
          go-version: "1.23"

      - name: æ›´æ–° Go ä¾èµ–
        run: |
          go mod tidy
          go get -u ./...
          go mod tidy

      - name: è¿è¡Œæµ‹è¯•
        run: |
          go test ./...

      - name: åˆ›å»º Pull Request
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "chore: update Go dependencies"
          title: "ğŸ”„ è‡ªåŠ¨æ›´æ–° Go ä¾èµ–"
          body: |
            ## ğŸ”„ è‡ªåŠ¨ä¾èµ–æ›´æ–°

            æ­¤ PR è‡ªåŠ¨æ›´æ–°äº† Go é¡¹ç›®çš„ä¾èµ–åŒ…åˆ°æœ€æ–°ç‰ˆæœ¬ã€‚

            ### ğŸ“‹ æ£€æŸ¥æ¸…å•
            - [x] ä¾èµ–æ›´æ–°å®Œæˆ
            - [x] æµ‹è¯•é€šè¿‡
            - [ ] æ‰‹åŠ¨éªŒè¯åŠŸèƒ½æ­£å¸¸

            ### ğŸ” è¯·æ³¨æ„
            è¯·ä»”ç»†æ£€æŸ¥æ›´æ–°çš„ä¾èµ–æ˜¯å¦å­˜åœ¨ç ´åæ€§å˜æ›´ã€‚
          branch: automated/update-go-dependencies
          delete-branch: true

  # ===== Node.js ä¾èµ–æ›´æ–° =====
  update-node-dependencies:
    name: æ›´æ–° Node.js ä¾èµ–
    runs-on: ubuntu-latest

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: è®¾ç½® Node.js ç¯å¢ƒ
        uses: actions/setup-node@v4
        with:
          node-version: "18"
          cache: "npm"
          cache-dependency-path: web/package-lock.json

      - name: å®‰è£… npm-check-updates
        run: npm install -g npm-check-updates

      - name: æ›´æ–° Node.js ä¾èµ–
        working-directory: ./web
        run: |
          # æ›´æ–° package.json ä¸­çš„ç‰ˆæœ¬
          ncu -u

          # å®‰è£…æ›´æ–°çš„ä¾èµ–
          npm install

          # ä¿®å¤å®‰å…¨æ¼æ´
          npm audit fix

      - name: è¿è¡Œæµ‹è¯•
        working-directory: ./web
        run: |
          npm run test
          npm run build

      - name: åˆ›å»º Pull Request
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "chore: update Node.js dependencies"
          title: "ğŸ”„ è‡ªåŠ¨æ›´æ–° Node.js ä¾èµ–"
          body: |
            ## ğŸ”„ è‡ªåŠ¨ä¾èµ–æ›´æ–°

            æ­¤ PR è‡ªåŠ¨æ›´æ–°äº†å‰ç«¯é¡¹ç›®çš„ Node.js ä¾èµ–åŒ…åˆ°æœ€æ–°ç‰ˆæœ¬ã€‚

            ### ğŸ“‹ æ£€æŸ¥æ¸…å•
            - [x] ä¾èµ–æ›´æ–°å®Œæˆ
            - [x] å®‰å…¨æ¼æ´ä¿®å¤
            - [x] æµ‹è¯•é€šè¿‡
            - [x] æ„å»ºæˆåŠŸ
            - [ ] æ‰‹åŠ¨éªŒè¯å‰ç«¯åŠŸèƒ½æ­£å¸¸

            ### ğŸ” è¯·æ³¨æ„
            è¯·ä»”ç»†æ£€æŸ¥æ›´æ–°çš„ä¾èµ–æ˜¯å¦å­˜åœ¨ç ´åæ€§å˜æ›´ã€‚
          branch: automated/update-node-dependencies
          delete-branch: true

  # ===== Docker åŸºç¡€é•œåƒæ›´æ–° =====
  update-docker-images:
    name: æ›´æ–° Docker åŸºç¡€é•œåƒ
    runs-on: ubuntu-latest

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: æ£€æŸ¥é•œåƒæ›´æ–°
        id: check-updates
        run: |
          # æ£€æŸ¥ Dockerfile ä¸­çš„åŸºç¡€é•œåƒ
          CURRENT_GO_IMAGE=$(grep "FROM golang:" deployments/Dockerfile | head -1 | cut -d' ' -f2)
          CURRENT_NODE_IMAGE=$(grep "FROM node:" deployments/Dockerfile | head -1 | cut -d' ' -f2)
          CURRENT_ALPINE_IMAGE=$(grep "FROM alpine:" deployments/Dockerfile | tail -1 | cut -d' ' -f2)

          echo "current-go-image=$CURRENT_GO_IMAGE" >> $GITHUB_OUTPUT
          echo "current-node-image=$CURRENT_NODE_IMAGE" >> $GITHUB_OUTPUT
          echo "current-alpine-image=$CURRENT_ALPINE_IMAGE" >> $GITHUB_OUTPUT

          # è·å–æœ€æ–°ç‰ˆæœ¬ï¼ˆè¿™é‡Œç®€åŒ–å¤„ç†ï¼Œå®é™…å¯ä»¥è°ƒç”¨ Docker Hub APIï¼‰
          LATEST_GO_IMAGE="golang:1.23-alpine"
          LATEST_NODE_IMAGE="node:18-alpine"
          LATEST_ALPINE_IMAGE="alpine:3.18"

          echo "latest-go-image=$LATEST_GO_IMAGE" >> $GITHUB_OUTPUT
          echo "latest-node-image=$LATEST_NODE_IMAGE" >> $GITHUB_OUTPUT
          echo "latest-alpine-image=$LATEST_ALPINE_IMAGE" >> $GITHUB_OUTPUT

          # æ£€æŸ¥æ˜¯å¦éœ€è¦æ›´æ–°
          NEEDS_UPDATE=false
          if [ "$CURRENT_GO_IMAGE" != "$LATEST_GO_IMAGE" ]; then
            NEEDS_UPDATE=true
          fi
          if [ "$CURRENT_NODE_IMAGE" != "$LATEST_NODE_IMAGE" ]; then
            NEEDS_UPDATE=true
          fi
          if [ "$CURRENT_ALPINE_IMAGE" != "$LATEST_ALPINE_IMAGE" ]; then
            NEEDS_UPDATE=true
          fi

          echo "needs-update=$NEEDS_UPDATE" >> $GITHUB_OUTPUT

      - name: æ›´æ–° Dockerfile
        if: steps.check-updates.outputs.needs-update == 'true'
        run: |
          # æ›´æ–°åŸºç¡€é•œåƒç‰ˆæœ¬
          sed -i "s|${{ steps.check-updates.outputs.current-go-image }}|${{ steps.check-updates.outputs.latest-go-image }}|g" deployments/Dockerfile
          sed -i "s|${{ steps.check-updates.outputs.current-node-image }}|${{ steps.check-updates.outputs.latest-node-image }}|g" deployments/Dockerfile
          sed -i "s|${{ steps.check-updates.outputs.current-alpine-image }}|${{ steps.check-updates.outputs.latest-alpine-image }}|g" deployments/Dockerfile

      - name: æµ‹è¯• Docker æ„å»º
        if: steps.check-updates.outputs.needs-update == 'true'
        run: |
          docker build -f deployments/Dockerfile -t test-image .

      - name: åˆ›å»º Pull Request
        if: steps.check-updates.outputs.needs-update == 'true'
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "chore: update Docker base images"
          title: "ğŸ³ è‡ªåŠ¨æ›´æ–° Docker åŸºç¡€é•œåƒ"
          body: |
            ## ğŸ³ Docker åŸºç¡€é•œåƒæ›´æ–°

            æ­¤ PR è‡ªåŠ¨æ›´æ–°äº† Dockerfile ä¸­çš„åŸºç¡€é•œåƒåˆ°æœ€æ–°ç‰ˆæœ¬ã€‚

            ### ğŸ“‹ æ›´æ–°å†…å®¹
            - Go é•œåƒ: `${{ steps.check-updates.outputs.current-go-image }}` â†’ `${{ steps.check-updates.outputs.latest-go-image }}`
            - Node é•œåƒ: `${{ steps.check-updates.outputs.current-node-image }}` â†’ `${{ steps.check-updates.outputs.latest-node-image }}`
            - Alpine é•œåƒ: `${{ steps.check-updates.outputs.current-alpine-image }}` â†’ `${{ steps.check-updates.outputs.latest-alpine-image }}`

            ### ğŸ“‹ æ£€æŸ¥æ¸…å•
            - [x] Dockerfile æ›´æ–°å®Œæˆ
            - [x] Docker æ„å»ºæµ‹è¯•é€šè¿‡
            - [ ] æ‰‹åŠ¨éªŒè¯åº”ç”¨æ­£å¸¸è¿è¡Œ

            ### ğŸ” è¯·æ³¨æ„
            è¯·éªŒè¯é•œåƒæ›´æ–°ååº”ç”¨çš„å…¼å®¹æ€§å’Œå®‰å…¨æ€§ã€‚
          branch: automated/update-docker-images
          delete-branch: true
