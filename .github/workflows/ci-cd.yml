# CI/CD å·¥ä½œæµé…ç½®
name: CI/CD Pipeline

on:
  # é»˜è®¤ç¦ç”¨è‡ªåŠ¨è§¦å‘ï¼Œéœ€è¦æ‰‹åŠ¨å¯ç”¨
  # push:
  #   branches: [main, develop]
  #   tags: ["v*"]
  # pull_request:
  #   branches: [main, develop]
  workflow_dispatch:
    inputs:
      enable_workflow:
        description: "å¯ç”¨å·¥ä½œæµï¼ˆé»˜è®¤ç¦ç”¨ï¼‰"
        required: true
        default: false
        type: boolean
      environment:
        description: "éƒ¨ç½²ç¯å¢ƒ"
        required: true
        default: "staging"
        type: choice
        options:
          - staging
          - production
      skip_tests:
        description: "è·³è¿‡æµ‹è¯•"
        required: false
        default: false
        type: boolean

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}
  GO_VERSION: "1.23"
  NODE_VERSION: "18"

jobs:
  # ===== ä»£ç è´¨é‡æ£€æŸ¥ =====
  code-quality:
    name: ä»£ç è´¨é‡æ£€æŸ¥
    runs-on: ubuntu-latest
    if: ${{ inputs.enable_workflow == true }}
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: è®¾ç½® Go ç¯å¢ƒ
        uses: actions/setup-go@v4
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: è®¾ç½® Node.js ç¯å¢ƒ
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"
          cache-dependency-path: web/package-lock.json

      # Go ä»£ç æ£€æŸ¥
      - name: Go ä»£ç æ ¼å¼æ£€æŸ¥
        run: |
          if [ "$(gofmt -s -l . | wc -l)" -gt 0 ]; then
            echo "ä»£ç æ ¼å¼ä¸ç¬¦åˆè§„èŒƒï¼š"
            gofmt -s -l .
            exit 1
          fi

      - name: Go é™æ€åˆ†æ
        uses: golangci/golangci-lint-action@v3
        with:
          version: latest
          args: --timeout=5m

      - name: Go å®‰å…¨æ‰«æ
        uses: securecodewarrior/github-action-gosec@master
        with:
          args: "./..."

      # å‰ç«¯ä»£ç æ£€æŸ¥
      - name: å®‰è£…å‰ç«¯ä¾èµ–
        working-directory: ./web
        run: npm ci

      - name: å‰ç«¯ä»£ç æ£€æŸ¥
        working-directory: ./web
        run: |
          npm run lint
          npm run type-check

      - name: å‰ç«¯å®‰å…¨æ‰«æ
        working-directory: ./web
        run: npm audit --audit-level=high

  # ===== å•å…ƒæµ‹è¯• =====
  unit-tests:
    name: å•å…ƒæµ‹è¯•
    runs-on: ubuntu-latest
    if: ${{ inputs.enable_workflow == true && !inputs.skip_tests }}
    needs: code-quality

    services:
      postgres:
        image: postgres:15-alpine
        env:
          POSTGRES_PASSWORD: testpass
          POSTGRES_USER: testuser
          POSTGRES_DB: testdb
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

      redis:
        image: redis:7-alpine
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 6379:6379

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½® Go ç¯å¢ƒ
        uses: actions/setup-go@v4
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: è®¾ç½® Node.js ç¯å¢ƒ
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"
          cache-dependency-path: web/package-lock.json

      # Go æµ‹è¯•
      - name: Go å•å…ƒæµ‹è¯•
        env:
          DB_HOST: localhost
          DB_PORT: 5432
          DB_USER: testuser
          DB_PASSWORD: testpass
          DB_NAME: testdb
          REDIS_HOST: localhost
          REDIS_PORT: 6379
          JWT_SECRET: test-secret-key-for-testing-purposes-only
          ENCRYPTION_KEY: 12345678901234567890123456789012
        run: |
          go mod download
          go test -v -race -coverprofile=coverage.out ./...
          go tool cover -html=coverage.out -o coverage.html

      - name: ä¸Šä¼  Go æµ‹è¯•è¦†ç›–ç‡
        uses: codecov/codecov-action@v3
        with:
          file: ./coverage.out
          flags: backend

      # å‰ç«¯æµ‹è¯•
      - name: å®‰è£…å‰ç«¯ä¾èµ–
        working-directory: ./web
        run: npm ci

      - name: å‰ç«¯å•å…ƒæµ‹è¯•
        working-directory: ./web
        run: npm run test:coverage

      - name: ä¸Šä¼ å‰ç«¯æµ‹è¯•è¦†ç›–ç‡
        uses: codecov/codecov-action@v3
        with:
          directory: ./web/coverage
          flags: frontend

  # ===== é›†æˆæµ‹è¯• =====
  integration-tests:
    name: é›†æˆæµ‹è¯•
    runs-on: ubuntu-latest
    if: ${{ inputs.enable_workflow == true && !inputs.skip_tests }}
    needs: unit-tests

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½®æµ‹è¯•ç¯å¢ƒ
        run: |
          cp deployments/.env.example deployments/.env
          echo "DB_PASSWORD=testpass123" >> deployments/.env
          echo "JWT_SECRET=test-jwt-secret-key-for-integration-testing" >> deployments/.env
          echo "ENCRYPTION_KEY=12345678901234567890123456789012" >> deployments/.env

      - name: å¯åŠ¨æµ‹è¯•ç¯å¢ƒ
        run: |
          cd deployments
          docker-compose up -d --build

          # ç­‰å¾…æœåŠ¡å¯åŠ¨
          timeout 300 bash -c 'until curl -f http://localhost:8080/api/health; do sleep 5; done'

      - name: è¿è¡Œé›†æˆæµ‹è¯•
        run: |
          chmod +x scripts/system-test.sh
          ./scripts/system-test.sh

      - name: æ”¶é›†æ—¥å¿—
        if: failure()
        run: |
          cd deployments
          docker-compose logs > ../integration-test-logs.txt

      - name: ä¸Šä¼ æµ‹è¯•æ—¥å¿—
        if: failure()
        uses: actions/upload-artifact@v3
        with:
          name: integration-test-logs
          path: integration-test-logs.txt

      - name: æ¸…ç†æµ‹è¯•ç¯å¢ƒ
        if: always()
        run: |
          cd deployments
          docker-compose down -v

  # ===== æ„å»ºé•œåƒ =====
  build-image:
    name: æ„å»º Docker é•œåƒ
    runs-on: ubuntu-latest
    needs: [code-quality, unit-tests]
    if: ${{ inputs.enable_workflow == true && always() && (needs.code-quality.result == 'success' && (needs.unit-tests.result == 'success' || inputs.skip_tests)) }}

    outputs:
      image-digest: ${{ steps.build.outputs.digest }}
      image-tags: ${{ steps.meta.outputs.tags }}

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½® Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: ç™»å½•åˆ°å®¹å™¨æ³¨å†Œè¡¨
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: ç”Ÿæˆé•œåƒå…ƒæ•°æ®
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=ref,event=branch
            type=ref,event=pr
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=semver,pattern={{major}}
            type=raw,value=latest,enable={{is_default_branch}}
            type=sha,prefix={{branch}}-

      - name: æ„å»ºå¹¶æ¨é€é•œåƒ
        id: build
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./deployments/Dockerfile
          platforms: linux/amd64,linux/arm64
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            VERSION=${{ steps.meta.outputs.version }}
            BUILDTIME=${{ github.event.head_commit.timestamp }}

  # ===== å®‰å…¨æ‰«æ =====
  security-scan:
    name: å®‰å…¨æ‰«æ
    runs-on: ubuntu-latest
    needs: build-image
    if: ${{ inputs.enable_workflow == true && always() && needs.build-image.result == 'success' }}

    steps:
      - name: è¿è¡Œ Trivy æ¼æ´æ‰«æ
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ fromJSON(needs.build-image.outputs.image-tags)[0] }}
          format: "sarif"
          output: "trivy-results.sarif"

      - name: ä¸Šä¼  Trivy æ‰«æç»“æœ
        uses: github/codeql-action/upload-sarif@v2
        if: always()
        with:
          sarif_file: "trivy-results.sarif"

      - name: æ£€æŸ¥ä¸¥é‡æ¼æ´
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ fromJSON(needs.build-image.outputs.image-tags)[0] }}
          format: "table"
          exit-code: "1"
          severity: "CRITICAL,HIGH"

  # ===== æ€§èƒ½æµ‹è¯• =====
  performance-test:
    name: æ€§èƒ½æµ‹è¯•
    runs-on: ubuntu-latest
    needs: build-image
    if: ${{ inputs.enable_workflow == true && github.event_name == 'workflow_dispatch' }}

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½®æµ‹è¯•ç¯å¢ƒ
        run: |
          cp deployments/.env.example deployments/.env
          echo "DB_PASSWORD=perftest123" >> deployments/.env
          echo "JWT_SECRET=performance-test-secret-key" >> deployments/.env
          echo "ENCRYPTION_KEY=12345678901234567890123456789012" >> deployments/.env

      - name: å¯åŠ¨æ€§èƒ½æµ‹è¯•ç¯å¢ƒ
        run: |
          cd deployments
          # ä½¿ç”¨æ„å»ºçš„é•œåƒ
          export IMAGE_TAG=${{ fromJSON(needs.build-image.outputs.image-tags)[0] }}
          docker-compose up -d
          timeout 300 bash -c 'until curl -f http://localhost:8080/api/health; do sleep 5; done'

      - name: å®‰è£… K6
        run: |
          sudo gpg -k
          sudo gpg --no-default-keyring --keyring /usr/share/keyrings/k6-archive-keyring.gpg --keyserver hkp://keyserver.ubuntu.com:80 --recv-keys C5AD17C747E3415A3642D57D77C6C491D6AC1D69
          echo "deb [signed-by=/usr/share/keyrings/k6-archive-keyring.gpg] https://dl.k6.io/deb stable main" | sudo tee /etc/apt/sources.list.d/k6.list
          sudo apt-get update
          sudo apt-get install k6

      - name: è¿è¡Œæ€§èƒ½æµ‹è¯•
        run: |
          k6 run --out json=performance-results.json scripts/performance-test.js

      - name: ä¸Šä¼ æ€§èƒ½æµ‹è¯•ç»“æœ
        uses: actions/upload-artifact@v3
        with:
          name: performance-results
          path: performance-results.json

      - name: æ¸…ç†æ€§èƒ½æµ‹è¯•ç¯å¢ƒ
        if: always()
        run: |
          cd deployments
          docker-compose down -v

  # ===== éƒ¨ç½²åˆ° Staging =====
  deploy-staging:
    name: éƒ¨ç½²åˆ° Staging
    runs-on: ubuntu-latest
    needs: [build-image, integration-tests, security-scan]
    if: ${{ inputs.enable_workflow == true && inputs.environment == 'staging' }}
    environment: staging

    steps:
      - name: éƒ¨ç½²åˆ° Staging ç¯å¢ƒ
        run: |
          echo "éƒ¨ç½²é•œåƒ ${{ fromJSON(needs.build-image.outputs.image-tags)[0] }} åˆ° Staging ç¯å¢ƒ"
          # è¿™é‡Œæ·»åŠ æ‚¨çš„ staging éƒ¨ç½²é€»è¾‘
          # ä¾‹å¦‚ï¼šæ›´æ–° Kubernetes deploymentã€è°ƒç”¨éƒ¨ç½² API ç­‰

      - name: è¿è¡Œå†’çƒŸæµ‹è¯•
        run: |
          # è¿è¡ŒåŸºæœ¬çš„å†’çƒŸæµ‹è¯•ç¡®ä¿éƒ¨ç½²æˆåŠŸ
          timeout 60 bash -c 'until curl -f https://staging.domain-max.com/api/health; do sleep 5; done'
          echo "Staging ç¯å¢ƒéƒ¨ç½²æˆåŠŸ"

  # ===== éƒ¨ç½²åˆ° Production =====
  deploy-production:
    name: éƒ¨ç½²åˆ° Production
    runs-on: ubuntu-latest
    needs: [build-image, integration-tests, security-scan, performance-test]
    if: ${{ inputs.enable_workflow == true && inputs.environment == 'production' }}
    environment: production

    steps:
      - name: éƒ¨ç½²åˆ° Production ç¯å¢ƒ
        run: |
          echo "éƒ¨ç½²é•œåƒ ${{ fromJSON(needs.build-image.outputs.image-tags)[0] }} åˆ° Production ç¯å¢ƒ"
          # è¿™é‡Œæ·»åŠ æ‚¨çš„ production éƒ¨ç½²é€»è¾‘

      - name: è¿è¡Œå†’çƒŸæµ‹è¯•
        run: |
          # è¿è¡Œç”Ÿäº§ç¯å¢ƒå†’çƒŸæµ‹è¯•
          timeout 60 bash -c 'until curl -f https://domain-max.com/api/health; do sleep 5; done'
          echo "Production ç¯å¢ƒéƒ¨ç½²æˆåŠŸ"

      - name: é€šçŸ¥éƒ¨ç½²æˆåŠŸ
        uses: 8398a7/action-slack@v3
        if: success()
        with:
          status: success
          text: "ğŸš€ Domain MAX å·²æˆåŠŸéƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ"
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

      - name: é€šçŸ¥éƒ¨ç½²å¤±è´¥
        uses: 8398a7/action-slack@v3
        if: failure()
        with:
          status: failure
          text: "âŒ Domain MAX ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²å¤±è´¥"
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

  # ===== æ¸…ç† =====
  cleanup:
    name: æ¸…ç†èµ„æº
    runs-on: ubuntu-latest
    needs: [deploy-staging, deploy-production]
    if: ${{ inputs.enable_workflow == true && always() }}

    steps:
      - name: æ¸…ç†æ—§é•œåƒ
        run: |
          echo "æ¸…ç†æ—§çš„ Docker é•œåƒå’Œç¼“å­˜"
          # ä¿ç•™æœ€è¿‘çš„ 5 ä¸ªç‰ˆæœ¬ï¼Œåˆ é™¤å…¶ä»–çš„
          # è¿™é‡Œå¯ä»¥æ·»åŠ æ¸…ç†é€»è¾‘
