# ç›‘æ§å·¥ä½œæµï¼ˆé»˜è®¤ç¦ç”¨ï¼‰
name: Monitoring

on:
  # é»˜è®¤ç¦ç”¨è‡ªåŠ¨è§¦å‘ï¼Œéœ€è¦æ‰‹åŠ¨å¯ç”¨
  # schedule:
  #   # æ¯5åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡åº”ç”¨å¥åº·çŠ¶æ€
  #   - cron: "*/5 * * * *"
  #   # æ¯å°æ—¶ç”Ÿæˆæ€§èƒ½æŠ¥å‘Š
  #   - cron: "0 * * * *"
  #   # æ¯å¤©ç”Ÿæˆå®Œæ•´ç›‘æ§æŠ¥å‘Š
  #   - cron: "0 8 * * *"
  workflow_dispatch:
    inputs:
      enable_workflow:
        description: "å¯ç”¨å·¥ä½œæµï¼ˆé»˜è®¤ç¦ç”¨ï¼‰"
        required: true
        default: false
        type: boolean
      monitoring_type:
        description: "ç›‘æ§ç±»å‹"
        required: true
        default: "health"
        type: choice
        options:
          - health
          - performance
          - security
          - full
      environment:
        description: "ç¯å¢ƒ"
        required: true
        default: "production"
        type: choice
        options:
          - staging
          - production

env:
  ENVIRONMENT: ${{ inputs.environment || 'production' }}
  MONITORING_TYPE: ${{ inputs.monitoring_type || 'health' }}

jobs:
  # ===== å¥åº·æ£€æŸ¥ =====
  health-check:
    name: åº”ç”¨å¥åº·æ£€æŸ¥
    runs-on: ubuntu-latest
    if: ${{ inputs.enable_workflow == true && (contains(inputs.monitoring_type, 'health') || inputs.monitoring_type == 'full') }}
    outputs:
      app-status: ${{ steps.check.outputs.app-status }}
      db-status: ${{ steps.check.outputs.db-status }}
      api-status: ${{ steps.check.outputs.api-status }}
      overall-status: ${{ steps.check.outputs.overall-status }}

    steps:
      - name: è®¾ç½®ç¯å¢ƒå˜é‡
        run: |
          if [ "$ENVIRONMENT" = "production" ]; then
            echo "APP_URL=${{ secrets.PROD_APP_URL }}" >> $GITHUB_ENV
            echo "API_URL=${{ secrets.PROD_API_URL }}" >> $GITHUB_ENV
          else
            echo "APP_URL=${{ secrets.STAGING_APP_URL }}" >> $GITHUB_ENV
            echo "API_URL=${{ secrets.STAGING_API_URL }}" >> $GITHUB_ENV
          fi

      - name: æ£€æŸ¥åº”ç”¨å¥åº·çŠ¶æ€
        id: check
        run: |
          echo "å¼€å§‹å¥åº·æ£€æŸ¥..."

          # åˆå§‹åŒ–çŠ¶æ€
          APP_STATUS="unknown"
          DB_STATUS="unknown"
          API_STATUS="unknown"
          OVERALL_STATUS="healthy"

          # æ£€æŸ¥åº”ç”¨ä¸»é¡µ
          if [ -n "$APP_URL" ]; then
            echo "æ£€æŸ¥åº”ç”¨ä¸»é¡µ: $APP_URL"
            if curl -s -o /dev/null -w "%{http_code}" "$APP_URL" | grep -q "200"; then
              APP_STATUS="healthy"
              echo "âœ… åº”ç”¨ä¸»é¡µæ­£å¸¸"
            else
              APP_STATUS="unhealthy"
              OVERALL_STATUS="unhealthy"
              echo "âŒ åº”ç”¨ä¸»é¡µå¼‚å¸¸"
            fi
          else
            echo "âš ï¸ æœªé…ç½®åº”ç”¨URL"
          fi

          # æ£€æŸ¥APIå¥åº·ç«¯ç‚¹
          if [ -n "$API_URL" ]; then
            echo "æ£€æŸ¥APIå¥åº·ç«¯ç‚¹: $API_URL/health"
            HEALTH_RESPONSE=$(curl -s "$API_URL/health" 2>/dev/null || echo '{"status":"error"}')
            
            if echo "$HEALTH_RESPONSE" | grep -q '"status":"ok"'; then
              API_STATUS="healthy"
              echo "âœ… APIå¥åº·æ£€æŸ¥æ­£å¸¸"
              
              # æ£€æŸ¥æ•°æ®åº“è¿æ¥
              if echo "$HEALTH_RESPONSE" | grep -q '"database":"connected"'; then
                DB_STATUS="healthy"
                echo "âœ… æ•°æ®åº“è¿æ¥æ­£å¸¸"
              else
                DB_STATUS="unhealthy"
                OVERALL_STATUS="unhealthy"
                echo "âŒ æ•°æ®åº“è¿æ¥å¼‚å¸¸"
              fi
            else
              API_STATUS="unhealthy"
              OVERALL_STATUS="unhealthy"
              echo "âŒ APIå¥åº·æ£€æŸ¥å¤±è´¥"
              echo "å“åº”: $HEALTH_RESPONSE"
            fi
          else
            echo "âš ï¸ æœªé…ç½®API URL"
          fi

          # è¾“å‡ºçŠ¶æ€
          echo "app-status=$APP_STATUS" >> $GITHUB_OUTPUT
          echo "db-status=$DB_STATUS" >> $GITHUB_OUTPUT
          echo "api-status=$API_STATUS" >> $GITHUB_OUTPUT
          echo "overall-status=$OVERALL_STATUS" >> $GITHUB_OUTPUT

          echo "=== å¥åº·æ£€æŸ¥ç»“æœ ==="
          echo "åº”ç”¨çŠ¶æ€: $APP_STATUS"
          echo "APIçŠ¶æ€: $API_STATUS"
          echo "æ•°æ®åº“çŠ¶æ€: $DB_STATUS"
          echo "æ•´ä½“çŠ¶æ€: $OVERALL_STATUS"

      - name: æ£€æŸ¥SSLè¯ä¹¦
        run: |
          if [ -n "$APP_URL" ]; then
            DOMAIN=$(echo "$APP_URL" | sed 's|https\?://||' | sed 's|/.*||')
            echo "æ£€æŸ¥SSLè¯ä¹¦: $DOMAIN"
            
            # è·å–è¯ä¹¦åˆ°æœŸæ—¶é—´
            CERT_INFO=$(echo | openssl s_client -servername "$DOMAIN" -connect "$DOMAIN:443" 2>/dev/null | openssl x509 -noout -dates 2>/dev/null || echo "")
            
            if [ -n "$CERT_INFO" ]; then
              EXPIRY_DATE=$(echo "$CERT_INFO" | grep "notAfter" | cut -d= -f2)
              EXPIRY_TIMESTAMP=$(date -d "$EXPIRY_DATE" +%s 2>/dev/null || echo "0")
              CURRENT_TIMESTAMP=$(date +%s)
              DAYS_UNTIL_EXPIRY=$(( (EXPIRY_TIMESTAMP - CURRENT_TIMESTAMP) / 86400 ))
              
              echo "SSLè¯ä¹¦åˆ°æœŸæ—¶é—´: $EXPIRY_DATE"
              echo "è·ç¦»åˆ°æœŸè¿˜æœ‰: $DAYS_UNTIL_EXPIRY å¤©"
              
              if [ $DAYS_UNTIL_EXPIRY -lt 30 ]; then
                echo "âš ï¸ SSLè¯ä¹¦å³å°†åˆ°æœŸ ($DAYS_UNTIL_EXPIRY å¤©)"
                echo "SSL_WARNING=true" >> $GITHUB_ENV
              else
                echo "âœ… SSLè¯ä¹¦æ­£å¸¸"
              fi
            else
              echo "âš ï¸ æ— æ³•è·å–SSLè¯ä¹¦ä¿¡æ¯"
            fi
          fi

      - name: æ£€æŸ¥DNSè®°å½•
        run: |
          if [ -n "$APP_URL" ]; then
            DOMAIN=$(echo "$APP_URL" | sed 's|https\?://||' | sed 's|/.*||')
            echo "æ£€æŸ¥DNSè®°å½•: $DOMAIN"
            
            # æ£€æŸ¥Aè®°å½•
            A_RECORD=$(dig +short "$DOMAIN" A 2>/dev/null || echo "")
            if [ -n "$A_RECORD" ]; then
              echo "âœ… Aè®°å½•: $A_RECORD"
            else
              echo "âŒ Aè®°å½•è§£æå¤±è´¥"
            fi
            
            # æ£€æŸ¥AAAAè®°å½•ï¼ˆIPv6ï¼‰
            AAAA_RECORD=$(dig +short "$DOMAIN" AAAA 2>/dev/null || echo "")
            if [ -n "$AAAA_RECORD" ]; then
              echo "âœ… AAAAè®°å½•: $AAAA_RECORD"
            else
              echo "âš ï¸ æ— IPv6è®°å½•"
            fi
          fi

  # ===== æ€§èƒ½ç›‘æ§ =====
  performance-check:
    name: æ€§èƒ½ç›‘æ§
    runs-on: ubuntu-latest
    if: contains(env.MONITORING_TYPE, 'performance') || env.MONITORING_TYPE == 'full'
    outputs:
      response-time: ${{ steps.perf.outputs.response-time }}
      page-load-time: ${{ steps.perf.outputs.page-load-time }}
      performance-score: ${{ steps.perf.outputs.performance-score }}

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½®ç¯å¢ƒå˜é‡
        run: |
          if [ "$ENVIRONMENT" = "production" ]; then
            echo "APP_URL=${{ secrets.PROD_APP_URL }}" >> $GITHUB_ENV
            echo "API_URL=${{ secrets.PROD_API_URL }}" >> $GITHUB_ENV
          else
            echo "APP_URL=${{ secrets.STAGING_APP_URL }}" >> $GITHUB_ENV
            echo "API_URL=${{ secrets.STAGING_API_URL }}" >> $GITHUB_ENV
          fi

      - name: æ€§èƒ½åŸºå‡†æµ‹è¯•
        id: perf
        run: |
          echo "å¼€å§‹æ€§èƒ½ç›‘æ§..."

          # APIå“åº”æ—¶é—´æµ‹è¯•
          if [ -n "$API_URL" ]; then
            echo "æµ‹è¯•APIå“åº”æ—¶é—´..."
            
            # æµ‹è¯•ç™»å½•API
            LOGIN_TIME=$(curl -w "%{time_total}" -s -o /dev/null "$API_URL/auth/health" 2>/dev/null || echo "0")
            
            # æµ‹è¯•åŸŸåAPI
            DOMAIN_TIME=$(curl -w "%{time_total}" -s -o /dev/null "$API_URL/domains" 2>/dev/null || echo "0")
            
            # è®¡ç®—å¹³å‡å“åº”æ—¶é—´
            RESPONSE_TIME=$(echo "scale=3; ($LOGIN_TIME + $DOMAIN_TIME) / 2" | bc 2>/dev/null || echo "0")
            
            echo "å¹³å‡APIå“åº”æ—¶é—´: ${RESPONSE_TIME}s"
            echo "response-time=$RESPONSE_TIME" >> $GITHUB_OUTPUT
            
            # å“åº”æ—¶é—´è­¦å‘Šé˜ˆå€¼
            if (( $(echo "$RESPONSE_TIME > 2.0" | bc -l) )); then
              echo "âš ï¸ APIå“åº”æ—¶é—´è¿‡æ…¢: ${RESPONSE_TIME}s"
              echo "API_SLOW=true" >> $GITHUB_ENV
            else
              echo "âœ… APIå“åº”æ—¶é—´æ­£å¸¸"
            fi
          fi

      - name: é¡µé¢åŠ è½½æ€§èƒ½æµ‹è¯•
        run: |
          if [ -n "$APP_URL" ]; then
            echo "æµ‹è¯•é¡µé¢åŠ è½½æ€§èƒ½..."
            
            # ä½¿ç”¨curlæµ‹è¯•é¡µé¢åŠ è½½æ—¶é—´
            PAGE_LOAD_TIME=$(curl -w "%{time_total}" -s -o /dev/null "$APP_URL" 2>/dev/null || echo "0")
            echo "é¡µé¢åŠ è½½æ—¶é—´: ${PAGE_LOAD_TIME}s"
            echo "page-load-time=$PAGE_LOAD_TIME" >> $GITHUB_OUTPUT
            
            # é¡µé¢åŠ è½½æ—¶é—´è­¦å‘Šé˜ˆå€¼
            if (( $(echo "$PAGE_LOAD_TIME > 5.0" | bc -l) )); then
              echo "âš ï¸ é¡µé¢åŠ è½½æ—¶é—´è¿‡æ…¢: ${PAGE_LOAD_TIME}s"
              echo "PAGE_SLOW=true" >> $GITHUB_ENV
            else
              echo "âœ… é¡µé¢åŠ è½½æ—¶é—´æ­£å¸¸"
            fi
          fi

      - name: è®¡ç®—æ€§èƒ½è¯„åˆ†
        run: |
          # åŸºäºå“åº”æ—¶é—´å’Œé¡µé¢åŠ è½½æ—¶é—´è®¡ç®—æ€§èƒ½è¯„åˆ†
          RESPONSE_TIME="${{ steps.perf.outputs.response-time }}"
          PAGE_LOAD_TIME="${{ steps.perf.outputs.page-load-time }}"

          if [ -n "$RESPONSE_TIME" ] && [ -n "$PAGE_LOAD_TIME" ]; then
            # ç®€å•çš„è¯„åˆ†ç®—æ³•ï¼ˆ100åˆ†åˆ¶ï¼‰
            SCORE=100
            
            # APIå“åº”æ—¶é—´æ‰£åˆ†
            if (( $(echo "$RESPONSE_TIME > 1.0" | bc -l) )); then
              SCORE=$((SCORE - 20))
            elif (( $(echo "$RESPONSE_TIME > 0.5" | bc -l) )); then
              SCORE=$((SCORE - 10))
            fi
            
            # é¡µé¢åŠ è½½æ—¶é—´æ‰£åˆ†
            if (( $(echo "$PAGE_LOAD_TIME > 3.0" | bc -l) )); then
              SCORE=$((SCORE - 30))
            elif (( $(echo "$PAGE_LOAD_TIME > 2.0" | bc -l) )); then
              SCORE=$((SCORE - 15))
            fi
            
            echo "æ€§èƒ½è¯„åˆ†: $SCORE/100"
            echo "performance-score=$SCORE" >> $GITHUB_OUTPUT
            
            if [ $SCORE -lt 70 ]; then
              echo "âš ï¸ æ€§èƒ½è¯„åˆ†è¾ƒä½: $SCORE/100"
              echo "PERFORMANCE_LOW=true" >> $GITHUB_ENV
            else
              echo "âœ… æ€§èƒ½è¯„åˆ†è‰¯å¥½: $SCORE/100"
            fi
          fi

  # ===== å®‰å…¨ç›‘æ§ =====
  security-check:
    name: å®‰å…¨ç›‘æ§
    runs-on: ubuntu-latest
    if: contains(env.MONITORING_TYPE, 'security') || env.MONITORING_TYPE == 'full'
    outputs:
      security-score: ${{ steps.security.outputs.security-score }}
      vulnerabilities: ${{ steps.security.outputs.vulnerabilities }}

    steps:
      - name: è®¾ç½®ç¯å¢ƒå˜é‡
        run: |
          if [ "$ENVIRONMENT" = "production" ]; then
            echo "APP_URL=${{ secrets.PROD_APP_URL }}" >> $GITHUB_ENV
            echo "API_URL=${{ secrets.PROD_API_URL }}" >> $GITHUB_ENV
          else
            echo "APP_URL=${{ secrets.STAGING_APP_URL }}" >> $GITHUB_ENV
            echo "API_URL=${{ secrets.STAGING_API_URL }}" >> $GITHUB_ENV
          fi

      - name: å®‰å…¨æ£€æŸ¥
        id: security
        run: |
          echo "å¼€å§‹å®‰å…¨ç›‘æ§..."

          SECURITY_SCORE=100
          VULNERABILITIES=0

          if [ -n "$APP_URL" ]; then
            DOMAIN=$(echo "$APP_URL" | sed 's|https\?://||' | sed 's|/.*||')
            
            # æ£€æŸ¥HTTPå®‰å…¨å¤´
            echo "æ£€æŸ¥HTTPå®‰å…¨å¤´..."
            HEADERS=$(curl -I -s "$APP_URL" 2>/dev/null || echo "")
            
            # æ£€æŸ¥é‡è¦çš„å®‰å…¨å¤´
            if ! echo "$HEADERS" | grep -qi "strict-transport-security"; then
              echo "âŒ ç¼ºå°‘HSTSå¤´"
              SECURITY_SCORE=$((SECURITY_SCORE - 10))
              VULNERABILITIES=$((VULNERABILITIES + 1))
            fi
            
            if ! echo "$HEADERS" | grep -qi "x-frame-options"; then
              echo "âŒ ç¼ºå°‘X-Frame-Optionså¤´"
              SECURITY_SCORE=$((SECURITY_SCORE - 10))
              VULNERABILITIES=$((VULNERABILITIES + 1))
            fi
            
            if ! echo "$HEADERS" | grep -qi "x-content-type-options"; then
              echo "âŒ ç¼ºå°‘X-Content-Type-Optionså¤´"
              SECURITY_SCORE=$((SECURITY_SCORE - 5))
              VULNERABILITIES=$((VULNERABILITIES + 1))
            fi
            
            if ! echo "$HEADERS" | grep -qi "content-security-policy"; then
              echo "âŒ ç¼ºå°‘CSPå¤´"
              SECURITY_SCORE=$((SECURITY_SCORE - 15))
              VULNERABILITIES=$((VULNERABILITIES + 1))
            fi
            
            # æ£€æŸ¥æ˜¯å¦å¼ºåˆ¶HTTPS
            HTTP_URL=$(echo "$APP_URL" | sed 's|https://|http://|')
            HTTP_RESPONSE=$(curl -I -s "$HTTP_URL" 2>/dev/null || echo "")
            
            if ! echo "$HTTP_RESPONSE" | grep -qi "location.*https"; then
              echo "âŒ æœªå¼ºåˆ¶HTTPSé‡å®šå‘"
              SECURITY_SCORE=$((SECURITY_SCORE - 20))
              VULNERABILITIES=$((VULNERABILITIES + 1))
            fi
          fi

          echo "å®‰å…¨è¯„åˆ†: $SECURITY_SCORE/100"
          echo "å‘ç°æ¼æ´: $VULNERABILITIES ä¸ª"

          echo "security-score=$SECURITY_SCORE" >> $GITHUB_OUTPUT
          echo "vulnerabilities=$VULNERABILITIES" >> $GITHUB_OUTPUT

          if [ $SECURITY_SCORE -lt 80 ]; then
            echo "âš ï¸ å®‰å…¨è¯„åˆ†è¾ƒä½: $SECURITY_SCORE/100"
            echo "SECURITY_LOW=true" >> $GITHUB_ENV
          else
            echo "âœ… å®‰å…¨è¯„åˆ†è‰¯å¥½: $SECURITY_SCORE/100"
          fi

      - name: ç«¯å£æ‰«ææ£€æŸ¥
        run: |
          if [ -n "$APP_URL" ]; then
            DOMAIN=$(echo "$APP_URL" | sed 's|https\?://||' | sed 's|/.*||')
            echo "æ£€æŸ¥å¸¸è§ç«¯å£çŠ¶æ€..."
            
            # æ£€æŸ¥å¸¸è§ä¸å®‰å…¨ç«¯å£æ˜¯å¦å¼€æ”¾
            DANGEROUS_PORTS="21 22 23 25 53 110 143 993 995 1433 3306 5432 6379 27017"
            
            for port in $DANGEROUS_PORTS; do
              if timeout 3 nc -z "$DOMAIN" "$port" 2>/dev/null; then
                echo "âš ï¸ å‘ç°å¼€æ”¾ç«¯å£: $port"
                echo "OPEN_PORTS=true" >> $GITHUB_ENV
              fi
            done
          fi

  # ===== èµ„æºä½¿ç”¨ç›‘æ§ =====
  resource-check:
    name: èµ„æºä½¿ç”¨ç›‘æ§
    runs-on: ubuntu-latest
    if: env.MONITORING_TYPE == 'full'

    steps:
      - name: æ£€æŸ¥åŸŸåè§£ææ€§èƒ½
        run: |
          if [ -n "${{ env.APP_URL }}" ]; then
            DOMAIN=$(echo "${{ env.APP_URL }}" | sed 's|https\?://||' | sed 's|/.*||')
            echo "æ£€æŸ¥DNSè§£ææ€§èƒ½..."
            
            # æµ‹è¯•DNSè§£ææ—¶é—´
            DNS_TIME=$(dig +stats "$DOMAIN" | grep "Query time" | awk '{print $4}' || echo "0")
            echo "DNSè§£ææ—¶é—´: ${DNS_TIME}ms"
            
            if [ "$DNS_TIME" -gt 100 ]; then
              echo "âš ï¸ DNSè§£ææ—¶é—´è¿‡é•¿: ${DNS_TIME}ms"
              echo "DNS_SLOW=true" >> $GITHUB_ENV
            else
              echo "âœ… DNSè§£ææ€§èƒ½æ­£å¸¸"
            fi
          fi

      - name: æ£€æŸ¥CDNæ€§èƒ½
        run: |
          if [ -n "${{ env.APP_URL }}" ]; then
            echo "æ£€æŸ¥CDNæ€§èƒ½..."
            
            # æ£€æŸ¥æ˜¯å¦ä½¿ç”¨CDN
            CDN_HEADERS=$(curl -I -s "${{ env.APP_URL }}" | grep -i "server\|cache\|cdn" || echo "")
            
            if [ -n "$CDN_HEADERS" ]; then
              echo "âœ… æ£€æµ‹åˆ°CDNä½¿ç”¨"
              echo "$CDN_HEADERS"
            else
              echo "âš ï¸ æœªæ£€æµ‹åˆ°CDNä½¿ç”¨"
              echo "NO_CDN=true" >> $GITHUB_ENV
            fi
          fi

  # ===== ç”Ÿæˆç›‘æ§æŠ¥å‘Š =====
  generate-report:
    name: ç”Ÿæˆç›‘æ§æŠ¥å‘Š
    runs-on: ubuntu-latest
    needs: [health-check, performance-check, security-check, resource-check]
    if: always()

    steps:
      - name: ç”Ÿæˆç›‘æ§æŠ¥å‘Š
        run: |
          echo "# ğŸ“Š Domain MAX ç›‘æ§æŠ¥å‘Š" > monitoring-report.md
          echo "" >> monitoring-report.md
          echo "**ç›‘æ§æ—¶é—´**: $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> monitoring-report.md
          echo "**ç¯å¢ƒ**: $ENVIRONMENT" >> monitoring-report.md
          echo "**ç›‘æ§ç±»å‹**: $MONITORING_TYPE" >> monitoring-report.md
          echo "" >> monitoring-report.md

          # å¥åº·çŠ¶æ€æ‘˜è¦
          echo "## ğŸ¥ å¥åº·çŠ¶æ€æ‘˜è¦" >> monitoring-report.md
          echo "" >> monitoring-report.md

          OVERALL_STATUS="${{ needs.health-check.outputs.overall-status }}"
          if [ "$OVERALL_STATUS" = "healthy" ]; then
            echo "ğŸŸ¢ **æ•´ä½“çŠ¶æ€**: å¥åº·" >> monitoring-report.md
          else
            echo "ğŸ”´ **æ•´ä½“çŠ¶æ€**: å¼‚å¸¸" >> monitoring-report.md
          fi
          echo "" >> monitoring-report.md

          echo "| æ£€æŸ¥é¡¹ç›® | çŠ¶æ€ | è¯¦æƒ… |" >> monitoring-report.md
          echo "|---------|------|------|" >> monitoring-report.md
          echo "| åº”ç”¨çŠ¶æ€ | ${{ needs.health-check.outputs.app-status == 'healthy' && 'âœ… æ­£å¸¸' || 'âŒ å¼‚å¸¸' }} | åº”ç”¨ä¸»é¡µè®¿é—® |" >> monitoring-report.md
          echo "| APIçŠ¶æ€ | ${{ needs.health-check.outputs.api-status == 'healthy' && 'âœ… æ­£å¸¸' || 'âŒ å¼‚å¸¸' }} | APIå¥åº·ç«¯ç‚¹ |" >> monitoring-report.md
          echo "| æ•°æ®åº“çŠ¶æ€ | ${{ needs.health-check.outputs.db-status == 'healthy' && 'âœ… æ­£å¸¸' || 'âŒ å¼‚å¸¸' }} | æ•°æ®åº“è¿æ¥ |" >> monitoring-report.md
          echo "" >> monitoring-report.md

          # æ€§èƒ½ç›‘æ§ç»“æœ
          if [ "${{ needs.performance-check.result }}" != "skipped" ]; then
            echo "## âš¡ æ€§èƒ½ç›‘æ§" >> monitoring-report.md
            echo "" >> monitoring-report.md
            
            RESPONSE_TIME="${{ needs.performance-check.outputs.response-time }}"
            PAGE_LOAD_TIME="${{ needs.performance-check.outputs.page-load-time }}"
            PERF_SCORE="${{ needs.performance-check.outputs.performance-score }}"
            
            echo "| æŒ‡æ ‡ | å€¼ | çŠ¶æ€ |" >> monitoring-report.md
            echo "|------|----|----- |" >> monitoring-report.md
            echo "| APIå“åº”æ—¶é—´ | ${RESPONSE_TIME}s | ${{ env.API_SLOW == 'true' && 'âš ï¸ åæ…¢' || 'âœ… æ­£å¸¸' }} |" >> monitoring-report.md
            echo "| é¡µé¢åŠ è½½æ—¶é—´ | ${PAGE_LOAD_TIME}s | ${{ env.PAGE_SLOW == 'true' && 'âš ï¸ åæ…¢' || 'âœ… æ­£å¸¸' }} |" >> monitoring-report.md
            echo "| æ€§èƒ½è¯„åˆ† | ${PERF_SCORE}/100 | ${{ env.PERFORMANCE_LOW == 'true' && 'âš ï¸ å¾…æ”¹è¿›' || 'âœ… è‰¯å¥½' }} |" >> monitoring-report.md
            echo "" >> monitoring-report.md
          fi

          # å®‰å…¨ç›‘æ§ç»“æœ
          if [ "${{ needs.security-check.result }}" != "skipped" ]; then
            echo "## ğŸ” å®‰å…¨ç›‘æ§" >> monitoring-report.md
            echo "" >> monitoring-report.md
            
            SECURITY_SCORE="${{ needs.security-check.outputs.security-score }}"
            VULNERABILITIES="${{ needs.security-check.outputs.vulnerabilities }}"
            
            echo "| æŒ‡æ ‡ | å€¼ | çŠ¶æ€ |" >> monitoring-report.md
            echo "|------|----|----- |" >> monitoring-report.md
            echo "| å®‰å…¨è¯„åˆ† | ${SECURITY_SCORE}/100 | ${{ env.SECURITY_LOW == 'true' && 'âš ï¸ éœ€è¦å…³æ³¨' || 'âœ… è‰¯å¥½' }} |" >> monitoring-report.md
            echo "| å‘ç°æ¼æ´ | ${VULNERABILITIES} ä¸ª | ${{ needs.security-check.outputs.vulnerabilities != '0' && 'âš ï¸ éœ€è¦ä¿®å¤' || 'âœ… æœªå‘ç°' }} |" >> monitoring-report.md
            echo "" >> monitoring-report.md
          fi

          # è­¦å‘Šå’Œå»ºè®®
          echo "## âš ï¸ è­¦å‘Šå’Œå»ºè®®" >> monitoring-report.md
          echo "" >> monitoring-report.md

          HAS_WARNINGS=false

          if [ "${{ env.SSL_WARNING }}" = "true" ]; then
            echo "- ğŸ”´ **SSLè¯ä¹¦å³å°†åˆ°æœŸ**ï¼Œè¯·åŠæ—¶ç»­æœŸ" >> monitoring-report.md
            HAS_WARNINGS=true
          fi

          if [ "${{ env.API_SLOW }}" = "true" ]; then
            echo "- ğŸŸ¡ **APIå“åº”æ—¶é—´è¿‡æ…¢**ï¼Œå»ºè®®ä¼˜åŒ–åç«¯æ€§èƒ½" >> monitoring-report.md
            HAS_WARNINGS=true
          fi

          if [ "${{ env.PAGE_SLOW }}" = "true" ]; then
            echo "- ğŸŸ¡ **é¡µé¢åŠ è½½æ—¶é—´è¿‡é•¿**ï¼Œå»ºè®®ä¼˜åŒ–å‰ç«¯èµ„æº" >> monitoring-report.md
            HAS_WARNINGS=true
          fi

          if [ "${{ env.SECURITY_LOW }}" = "true" ]; then
            echo "- ğŸ”´ **å®‰å…¨è¯„åˆ†è¾ƒä½**ï¼Œè¯·æ£€æŸ¥HTTPå®‰å…¨å¤´é…ç½®" >> monitoring-report.md
            HAS_WARNINGS=true
          fi

          if [ "${{ env.DNS_SLOW }}" = "true" ]; then
            echo "- ğŸŸ¡ **DNSè§£æè¾ƒæ…¢**ï¼Œå»ºè®®æ£€æŸ¥DNSæœåŠ¡å™¨é…ç½®" >> monitoring-report.md
            HAS_WARNINGS=true
          fi

          if [ "${{ env.NO_CDN }}" = "true" ]; then
            echo "- ğŸŸ¡ **æœªä½¿ç”¨CDN**ï¼Œå»ºè®®å¯ç”¨CDNåŠ é€Ÿ" >> monitoring-report.md
            HAS_WARNINGS=true
          fi

          if [ "${{ env.OPEN_PORTS }}" = "true" ]; then
            echo "- ğŸ”´ **å‘ç°å¼€æ”¾çš„æ•æ„Ÿç«¯å£**ï¼Œè¯·æ£€æŸ¥é˜²ç«å¢™é…ç½®" >> monitoring-report.md
            HAS_WARNINGS=true
          fi

          if [ "$HAS_WARNINGS" = "false" ]; then
            echo "âœ… æœªå‘ç°éœ€è¦å…³æ³¨çš„é—®é¢˜ï¼Œç³»ç»Ÿè¿è¡Œè‰¯å¥½ã€‚" >> monitoring-report.md
          fi

          echo "" >> monitoring-report.md
          echo "---" >> monitoring-report.md
          echo "*æŠ¥å‘Šç”Ÿæˆæ—¶é—´: $(date -u '+%Y-%m-%d %H:%M:%S UTC')*" >> monitoring-report.md

      - name: ä¸Šä¼ ç›‘æ§æŠ¥å‘Š
        uses: actions/upload-artifact@v3
        with:
          name: monitoring-report-${{ env.ENVIRONMENT }}
          path: monitoring-report.md

      - name: å‘é€ç›‘æ§è­¦æŠ¥
        if: needs.health-check.outputs.overall-status != 'healthy' || env.SECURITY_LOW == 'true' || env.SSL_WARNING == 'true'
        uses: 8398a7/action-slack@v3
        with:
          status: custom
          custom_payload: |
            {
              "text": "ğŸš¨ Domain MAX ç›‘æ§è­¦æŠ¥",
              "attachments": [
                {
                  "color": "danger",
                  "fields": [
                    {
                      "title": "ç¯å¢ƒ",
                      "value": "${{ env.ENVIRONMENT }}",
                      "short": true
                    },
                    {
                      "title": "æ•´ä½“çŠ¶æ€",
                      "value": "${{ needs.health-check.outputs.overall-status }}",
                      "short": true
                    },
                    {
                      "title": "åº”ç”¨çŠ¶æ€",
                      "value": "${{ needs.health-check.outputs.app-status }}",
                      "short": true
                    },
                    {
                      "title": "æ•°æ®åº“çŠ¶æ€",
                      "value": "${{ needs.health-check.outputs.db-status }}",
                      "short": true
                    }
                  ]
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

      - name: å‘é€æ€§èƒ½æŠ¥å‘Š
        if: github.event.schedule == '0 8 * * *' && secrets.SLACK_WEBHOOK_URL
        uses: 8398a7/action-slack@v3
        with:
          status: custom
          custom_payload: |
            {
              "text": "ğŸ“Š Domain MAX æ¯æ—¥ç›‘æ§æŠ¥å‘Š",
              "attachments": [
                {
                  "color": "${{ needs.health-check.outputs.overall-status == 'healthy' && 'good' || 'warning' }}",
                  "fields": [
                    {
                      "title": "å¥åº·çŠ¶æ€",
                      "value": "${{ needs.health-check.outputs.overall-status }}",
                      "short": true
                    },
                    {
                      "title": "æ€§èƒ½è¯„åˆ†",
                      "value": "${{ needs.performance-check.outputs.performance-score }}/100",
                      "short": true
                    },
                    {
                      "title": "å®‰å…¨è¯„åˆ†",
                      "value": "${{ needs.security-check.outputs.security-score }}/100",
                      "short": true
                    },
                    {
                      "title": "APIå“åº”æ—¶é—´",
                      "value": "${{ needs.performance-check.outputs.response-time }}s",
                      "short": true
                    }
                  ]
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
